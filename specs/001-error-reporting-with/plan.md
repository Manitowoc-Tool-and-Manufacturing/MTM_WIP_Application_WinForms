# Implementation Plan: Error Reporting with User Notes & Offline Queue

**Branch**: `001-error-reporting-with` | **Date**: 2025-10-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-error-reporting-with/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implement a comprehensive error reporting system that allows users to submit error reports with contextual notes when exceptions occur. The system must support both online submission (when database is available) and offline queueing (when database is unavailable), with automatic synchronization on next successful connection. Key capabilities include: Report Issue dialog with user notes field, SQL file generation for offline reports, sequential sync processing on startup, manual sync trigger from Developer Settings, and pending report count badges.

## Technical Context

**Language/Version**: C# 12 / .NET 8.0 Windows Forms  
**Primary Dependencies**: MySql.Data 9.4.0, System.Text.Json (for offline queue serialization)  
**Storage**: MySQL 5.7+ via stored procedures only (error_reports table), local file system for offline queue  
**Testing**: Manual validation (per testing-standards.instructions.md), MSTest for integration tests  
**Target Platform**: Windows desktop (WinForms), manufacturing shop floor environment  
**Project Type**: Single desktop application with existing WinForms architecture  
**Performance Goals**:

-   Error report submission: <2 seconds online, <500ms offline queue
-   Startup sync: <500ms overhead for 10 pending reports
-   Manual sync: <5 seconds for 10 reports
-   UI responsiveness: Sub-100ms for button clicks

**Constraints**:

-   Must use existing Service_ErrorHandler integration (no MessageBox.Show)
-   Stored procedures only (no inline SQL)
-   All DAO methods return DaoResult<T> wrapper pattern
-   Background sync must not block application startup
-   Offline queue files must be valid SQL INSERT statements for manual recovery
-   Must support concurrent prevention (lock/semaphore pattern)

**Scale/Scope**:

-   Expected: 5-20 error reports per day per user
-   Max queue depth: 100 pending reports (30-day retention)
-   Database table: error_reports with 14 columns
-   UI components: 1 new dialog form, 1 Developer Settings menu item
-   Code additions: ~800-1200 lines across Forms/, Services/, Data/, Helpers/

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                                                 | Status  | Justification                                                                                                                                                                                                                                                                |
| --------------------------------------------------------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| I. Stored Procedure Only Database Access                  | âœ… PASS | All error report submissions will use stored procedure `sp_error_reports_Insert` via `Helper_Database_StoredProcedure`. Offline queue generates SQL INSERT statements that call the same stored procedure. No inline SQL in application code.                                |
| II. DaoResult<T> Wrapper Pattern                          | âœ… PASS | New `Dao_ErrorReports` class will return `DaoResult<int>` for insert operations (returning ReportID) and `DaoResult<DataTable>` for query operations. All database errors wrapped in DaoResult with proper exception handling.                                               |
| III. Region Organization and Method Ordering              | âœ… PASS | New forms and services will follow standard region organization: Fields, Properties, Constructors, Specific Functionality (Report Submission, Queue Management), Button Clicks, Helpers, Cleanup. Methods ordered publicâ†’protectedâ†’privateâ†’static within each region.        |
| IV. Manual Validation Testing Approach                    | âœ… PASS | Feature specification includes comprehensive manual test scenarios for all three user stories (P1: Report with Context, P1: Offline Reporting, P2: Manual Sync). Success criteria defined with measurable outcomes (SC-001 through SC-009).                                  |
| V. Environment-Aware Database Selection                   | âœ… PASS | Uses existing `Helper_Database_Variables.GetConnectionString()` for database connectivity. Debug builds target `mtm_wip_application_winforms_test`, Release builds target `MTM_WIP_Application_Winforms`. No hardcoded connection strings.                                   |
| VI. Async-First UI Responsiveness                         | âœ… PASS | All database operations async (`SubmitReportAsync`, `SyncPendingReportsAsync`). Background sync uses `Task.Run` to avoid blocking startup. Progress reporting via `Helper_StoredProcedureProgress` for sync operations >5 reports. No blocking `.Result` or `.Wait()` calls. |
| VII. Centralized Error Handling with Service_ErrorHandler | âœ… PASS | Report Issue dialog integrates with existing `Service_ErrorHandler` flow. New error reporting exceptions handled via Service_ErrorHandler with appropriate severity levels. No direct MessageBox.Show usage.                                                                 |
| VIII. Documentation and XML Comments                      | âœ… PASS | All public APIs in new Dao_ErrorReports, Service_ErrorReportSync, and Form_ReportIssue will include XML documentation with `<summary>`, `<param>`, `<returns>`, and `<exception>` tags. Complex algorithms documented inline.                                                |

**Overall Gate Status**: âœ… PASS - No violations. All principles satisfied by proposed design.

**Notes**:

-   Offline queue uses SQL file format specifically to maintain stored procedure pattern even when database unavailable
-   Sequential file processing prevents database lock conflicts per Constitution Principle I
-   Manual sync respects async patterns and uses semaphore to prevent concurrent execution
-   All error handling routes through Service_ErrorHandler maintaining centralized error presentation

## Project Structure

### Documentation (this feature)

```
specs/001-error-reporting-with/
â”œâ”€â”€ spec.md              # Feature specification (completed)
â”œâ”€â”€ plan.md              # This file (Phase 0-1 complete)
â”œâ”€â”€ research.md          # Phase 0 output (to be generated)
â”œâ”€â”€ data-model.md        # Phase 1 output (to be generated)
â”œâ”€â”€ quickstart.md        # Phase 1 output (to be generated)
â”œâ”€â”€ contracts/           # Phase 1 output (to be generated)
â”‚   â””â”€â”€ sp_error_reports_Insert.sql
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks - not created by /speckit.plan)
```

### Source Code (repository root)

```
MTM_WIP_Application_WinForms/
â”œâ”€â”€ Forms/
â”‚   â””â”€â”€ ErrorDialog/
â”‚       â”œâ”€â”€ Form_ReportIssue.cs              # NEW: Report Issue dialog
â”‚       â””â”€â”€ Form_ReportIssue.Designer.cs     # NEW: Designer code
â”‚
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ Dao_ErrorReports.cs                  # NEW: Error reports data access
â”‚
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ Service_ErrorReportQueue.cs          # NEW: Offline queue management
â”‚   â””â”€â”€ Service_ErrorReportSync.cs           # NEW: Startup/manual sync coordinator
â”‚
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Model_ErrorReport.cs                 # NEW: Error report entity
â”‚   â””â”€â”€ Model_QueuedErrorReport.cs           # NEW: Offline queue item
â”‚
â”œâ”€â”€ Helpers/
â”‚   â””â”€â”€ Helper_Database_StoredProcedure.cs   # EXISTING: Used for SP calls
â”‚
â”œâ”€â”€ Database/
â”‚   â””â”€â”€ UpdatedStoredProcedures/
â”‚       â””â”€â”€ ReadyForVerification/
â”‚           â””â”€â”€ sp_error_reports_Insert.sql  # NEW: Insert stored procedure
â”‚
â”œâ”€â”€ Controls/
â”‚   â””â”€â”€ SettingsForm/
â”‚       â””â”€â”€ Control_DeveloperSettings.cs     # MODIFIED: Add sync menu item
â”‚
â””â”€â”€ Program.cs                               # MODIFIED: Register startup sync
```

**Structure Decision**: Using existing single WinForms application structure. New components follow established patterns:

-   Forms in `Forms/ErrorDialog/` for new dialogs
-   Data access in `Data/` following DAO pattern
-   Services in `Services/` for business logic
-   Models in `Models/` for data entities
-   Stored procedures in `Database/UpdatedStoredProcedures/ReadyForVerification/`

**Integration Points**:

-   `Service_ErrorHandler` calls `Form_ReportIssue` when user clicks "Report Issue"
-   `Program.cs` startup sequence invokes `Service_ErrorReportSync.SyncOnStartupAsync()`
-   `Control_DeveloperSettings` menu item triggers `Service_ErrorReportSync.SyncManuallyAsync()`
-   Offline queue location: `%APPDATA%\MTM_Application\ErrorReports\Pending\` and `...\Sent\`

## Complexity Tracking

_Fill ONLY if Constitution Check has violations that must be justified_

**No violations to track** - All constitution principles satisfied by proposed design.

---

## Relevant Instruction Files

**Note**: These instruction files provide coding patterns and standards for implementation. Review relevant files when moving from planning to task execution.

### Core Development:

-   `.github/instructions/csharp-dotnet8.instructions.md` - Language features, WinForms patterns, async/await, file organization
-   `.github/instructions/mysql-database.instructions.md` - Stored procedures, connection management, Helper_Database_StoredProcedure usage
-   `.github/instructions/documentation.instructions.md` - XML comments, README structure, code documentation

### Quality & Security:

-   `.github/instructions/testing-standards.instructions.md` - Manual validation approach, success criteria, test scenarios
-   `.github/instructions/integration-testing.instructions.md` - Discovery-first workflow, method signature verification, DAO testing patterns
-   `.github/instructions/security-best-practices.instructions.md` - Input validation, credential management, SQL injection prevention
-   `.github/instructions/performance-optimization.instructions.md` - Async patterns, connection pooling, memory management, caching strategies
-   `.github/instructions/code-review-standards.instructions.md` - Quality gates, review process, common issues

### When to Use:

-   **During task generation** (`/speckit.tasks`): Reference to add instruction file pointers to specific tasks
-   **During implementation** (`/speckit.implement`): Load instruction files to apply correct patterns
-   **During code review**: Validate compliance with documented standards

**Instruction File Reference Format in Tasks**:

```markdown
-   [ ] T100 - Implement DAO method for inventory queries
    -   **Reference**: .github/instructions/mysql-database.instructions.md - Use Helper_Database_StoredProcedure pattern
    -   **Reference**: .github/instructions/csharp-dotnet8.instructions.md - Follow async/await patterns
```

---

## Phase Completion Summary

### âœ… Phase 0: Research - COMPLETE

**Output**: [research.md](./research.md) (18.6 KB)

**Resolved Questions**:

1. Offline queue file format â†’ SQL files calling stored procedures
2. Concurrent sync prevention â†’ SemaphoreSlim with immediate timeout
3. Startup sync performance â†’ Fire-and-forget background task
4. File move failure recovery â†’ Idempotent execution with retry
5. Queue directory location â†’ %APPDATA%\MTM_Application\ErrorReports\
6. Corrupted file handling â†’ .corrupt extension with isolation
7. Retention and cleanup â†’ 30-day configurable retention with startup cleanup

### âœ… Phase 1: Design - COMPLETE

**Outputs**:

-   [data-model.md](./data-model.md) (19.9 KB) - Entity definitions with validation rules
-   [contracts/sp_error_reports_Insert.sql](./contracts/sp_error_reports_Insert.sql) - Stored procedure contract
-   [quickstart.md](./quickstart.md) (18.9 KB) - Developer implementation guide
-   Updated [.github/copilot-instructions.md](../../.github/copilot-instructions.md) - Agent context registered

**Entities Defined**:

-   ErrorReport (14 attributes, MySQL table with indexes)
-   Model_ErrorReport (C# class)
-   Model_QueuedErrorReport (C# class for file system queue)

**Contracts Created**:

-   sp_error_reports_Insert stored procedure with 8 input parameters, 3 output parameters
-   Complete usage examples for C#, direct SQL, and offline queue scenarios

### âœ… Constitution Check (Post-Design) - PASS

All 8 constitution principles satisfied:

-   âœ… Stored Procedure Only Database Access
-   âœ… DaoResult<T> Wrapper Pattern
-   âœ… Region Organization and Method Ordering
-   âœ… Manual Validation Testing Approach
-   âœ… Environment-Aware Database Selection
-   âœ… Async-First UI Responsiveness
-   âœ… Centralized Error Handling with Service_ErrorHandler
-   âœ… Documentation and XML Comments

**No violations** - Design maintains constitutional compliance.

### ðŸ“‹ Next Phase: Task Generation

**Command**: `/speckit.tasks` or run `.specify/scripts/powershell/setup-tasks.ps1`

**Expected Output**: [tasks.md](./tasks.md) with implementation tasks organized by phase

**Task Categories** (estimated):

-   Phase 0: Database Setup (1-2 tasks)
-   Phase 1: Model & DAO Layer (3-4 tasks)
-   Phase 2: Services & Queue Management (4-5 tasks)
-   Phase 3: UI Forms & Integration (3-4 tasks)
-   Phase 4: Testing & Documentation (2-3 tasks)

**Estimated Tasks**: 13-18 tasks total

---

## Planning Complete

**Feature**: Error Reporting with User Notes & Offline Queue  
**Branch**: `001-error-reporting-with`  
**Documentation**: 91.5 KB across 7 files  
**Status**: âœ… Ready for task generation

**Generated Artifacts**:

-   âœ… spec.md (requirements, success criteria, user stories)
-   âœ… plan.md (this file - technical architecture)
-   âœ… research.md (design decisions and rationale)
-   âœ… data-model.md (entities, relationships, validation)
-   âœ… quickstart.md (developer implementation guide)
-   âœ… contracts/sp_error_reports_Insert.sql (stored procedure contract)
-   âœ… checklists/requirements.md (quality gates - PASSED)

**Ready For**:

-   Task breakdown with `/speckit.tasks`
-   Implementation with task execution workflow
-   Integration testing per manual validation checklist

---
