# Feature Specification: Error Reporting with User Notes & Offline Queue

**Feature Branch**: `feature/error-reporting-system`  
**Created**: 2025-10-25  
**Status**: Draft  
**Input**: Implement Report Issue functionality with user notes, database storage, and offline queue for connection failures

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Report Error with Context (Priority: P1)

When an error occurs, users can submit a detailed error report including their own description of what they were doing, ensuring developers have complete context for troubleshooting.

**Why this priority**: This is the core functionality that enables effective error tracking and diagnosis. Without user context, developers struggle to reproduce issues.

**Independent Test**: User can trigger an error, click "Report Issue", add notes describing their actions, and successfully submit the report. Developer can view the report with user notes in the error reports viewer.

**Acceptance Scenarios**:

1. **Given** user encounters an error and error dialog appears, **When** user clicks "Report Issue" button, **Then** Report Issue dialog opens with error summary displayed
2. **Given** Report Issue dialog is open, **When** user types notes in "What were you doing?" text box, **Then** notes are captured and included in report
3. **Given** user has filled in notes, **When** user clicks "Submit", **Then** report is saved to database and success message shows Report ID
4. **Given** database is available, **When** error report is submitted, **Then** record appears in error_reports table with all error details and user notes

---

### User Story 2 - Offline Error Reporting (Priority: P1)

When database connection is unavailable, users can still report errors which are queued locally and automatically submitted when connection is restored, ensuring no error reports are lost.

**Why this priority**: Manufacturing environments experience network outages. Critical errors must be captured even when offline.

**Independent Test**: Disconnect database, trigger error, submit report with notes. Report is saved as SQL file locally. Reconnect database and restart app. Verify report appears in database and local file is archived.

**Acceptance Scenarios**:

1. **Given** database connection is unavailable, **When** user clicks "Submit" on Report Issue dialog, **Then** SQL file is created in Pending folder and user sees "report will be submitted when connection restored" message
2. **Given** SQL files exist in Pending folder, **When** application starts with successful database connection, **Then** files are processed sequentially one at a time
3. **Given** 5 pending reports exist, **When** startup sync runs, **Then** each file is executed in chronological order with individual transactions
4. **Given** sync completes successfully, **When** processing finishes, **Then** SQL files are moved to Sent archive folder and notification shows "X reports submitted"
5. **Given** sync encounters error on file 3 of 5, **When** processing continues, **Then** files 1-2 are archived, file 3 stays in Pending, files 4-5 are processed

---

### User Story 3 - Manual Queue Sync (Priority: P2)

Developers can manually trigger synchronization of pending error reports without restarting the application, useful for immediate troubleshooting.

**Why this priority**: Provides developers control over when reports are synced, useful when investigating urgent issues.

**Independent Test**: Queue 3 offline reports. From Developer Settings menu, click "Sync Pending Reports". Verify all 3 are submitted and count updates.

**Acceptance Scenarios**:

1. **Given** pending reports exist in queue, **When** developer clicks "Sync Pending Reports" from Developer Settings, **Then** sync process runs and reports are submitted
2. **Given** sync is triggered manually, **When** processing completes, **Then** progress notification shows "X of Y reports submitted"

---

### Edge Cases

- **Large reports**: What happens when error details exceed TEXT field limits (64KB)? Truncate with indicator.
- **Corrupted SQL files**: How does system handle malformed SQL in queue? Skip file, log error, leave in Pending with .corrupt extension.
- **Duplicate reports**: What if same error is reported multiple times offline? Allow duplicates, ReportID differentiates.
- **Old pending reports**: How long are queued reports kept? Configurable MaxPendingAgeDays (default 30), cleanup on startup.
- **Concurrent sync**: What if user manually triggers sync while automatic sync is running? Lock/semaphore prevents concurrent execution.
- **Network share access**: What if queue directory is inaccessible? Fallback to local AppData, log warning.
- **Transaction failures**: What if INSERT succeeds but file move fails? Retry move on next sync, avoid duplicate inserts by checking ReportDate+UserName combination.

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST display "Report Issue" dialog when user clicks Report Issue button in error dialog
- **FR-002**: Report Issue dialog MUST show error summary (read-only) and multi-line text box for user notes
- **FR-003**: System MUST check database connectivity before attempting to submit error report
- **FR-004**: System MUST insert error report into error_reports table when database connection is available
- **FR-005**: System MUST generate timestamped SQL file in Pending folder when database connection is unavailable
- **FR-006**: SQL file MUST contain valid INSERT statement with all error report data including user notes
- **FR-007**: System MUST process pending SQL files sequentially on application startup after successful database connection
- **FR-008**: System MUST execute each pending SQL file in its own transaction to prevent rollback cascades
- **FR-009**: System MUST move successfully processed SQL files to Sent archive folder
- **FR-010**: System MUST leave failed SQL files in Pending folder for retry on next startup
- **FR-011**: System MUST display notification showing count of successfully submitted reports after sync
- **FR-012**: System MUST provide manual sync option in Developer Settings menu
- **FR-013**: System MUST show pending report count badge in Developer Settings menu
- **FR-014**: System MUST cleanup pending reports older than configurable MaxPendingAgeDays
- **FR-015**: User notes field MUST be optional but encouraged (placeholder text guides user)
- **FR-016**: System MUST display success message with Report ID when online submission succeeds
- **FR-017**: System MUST run sync process on background thread to avoid blocking application startup
- **FR-018**: System MUST show progress indicator when syncing more than 5 pending reports

### Key Entities

- **ErrorReport**: Represents a user-submitted error report
  - Attributes: ReportID, ReportDate, UserName, MachineName, AppVersion, ErrorType, ErrorSummary, UserNotes, TechnicalDetails, CallStack, Status, ReviewedBy, ReviewedDate, DeveloperNotes
  - Relationships: Belongs to User (by UserName), Status tracks lifecycle (New → Reviewed → Resolved)

- **PendingErrorReportFile**: Represents queued offline error report
  - Attributes: FileName, FilePath, CreationDate, FileSize, AttemptCount
  - Lifecycle: Created in Pending folder → Processed → Moved to Sent folder or remains in Pending if failed

---

## Database Schema

### Table: error_reports

```sql
CREATE TABLE error_reports (
    ReportID INT AUTO_INCREMENT PRIMARY KEY,
    ReportDate DATETIME NOT NULL,
    UserName VARCHAR(100) NOT NULL,
    MachineName VARCHAR(100),
    AppVersion VARCHAR(50),
    ErrorType VARCHAR(255),
    ErrorSummary TEXT,
    UserNotes TEXT,
    TechnicalDetails TEXT,
    CallStack TEXT,
    Status ENUM('New', 'Reviewed', 'Resolved') DEFAULT 'New',
    ReviewedBy VARCHAR(100),
    ReviewedDate DATETIME,
    DeveloperNotes TEXT,
    
    INDEX idx_user (UserName),
    INDEX idx_date (ReportDate DESC),
    INDEX idx_status (Status),
    INDEX idx_machine (MachineName)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### Stored Procedure: sp_error_reports_Insert

```sql
CREATE PROCEDURE sp_error_reports_Insert(
    IN p_UserName VARCHAR(100),
    IN p_MachineName VARCHAR(100),
    IN p_AppVersion VARCHAR(50),
    IN p_ErrorType VARCHAR(255),
    IN p_ErrorSummary TEXT,
    IN p_UserNotes TEXT,
    IN p_TechnicalDetails TEXT,
    IN p_CallStack TEXT,
    OUT p_ReportID INT,
    OUT p_Status INT,
    OUT p_ErrorMsg VARCHAR(500)
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_Status = -1;
        SET p_ErrorMsg = 'Database error occurred while inserting error report';
        SET p_ReportID = NULL;
    END;
    
    START TRANSACTION;
    
    INSERT INTO error_reports (
        ReportDate, UserName, MachineName, AppVersion,
        ErrorType, ErrorSummary, UserNotes, TechnicalDetails, CallStack, Status
    ) VALUES (
        NOW(), p_UserName, p_MachineName, p_AppVersion,
        p_ErrorType, p_ErrorSummary, p_UserNotes, p_TechnicalDetails, p_CallStack, 'New'
    );
    
    SET p_ReportID = LAST_INSERT_ID();
    SET p_Status = 0;
    SET p_ErrorMsg = 'Error report inserted successfully';
    
    COMMIT;
END;
```

---

## UI Mockups

### Report Issue Dialog

**OPTION A: Simple Modal with Notes at Bottom**
```
┌─────────────────────────────────────────────┐
│ Report Error                            [X] │
├─────────────────────────────────────────────┤
│                                             │
│ Error Summary:                              │
│ ┌─────────────────────────────────────────┐ │
│ │ An unexpected database connection error │ │
│ │ occurred. Please report this issue.     │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ What were you doing when this error         │
│ occurred? (Optional)                        │
│ ┌─────────────────────────────────────────┐ │
│ │                                         │ │
│ │ [User types context here]               │ │
│ │                                         │ │
│ │                                         │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│         [Submit Report]    [Cancel]         │
└─────────────────────────────────────────────┘
```

**OPTION B: Side-by-Side Layout**
```
┌────────────────────────────────────────────────────────┐
│ Report Error                                       [X] │
├──────────────────────────┬─────────────────────────────┤
│ Error Details (Read-Only)│ Your Notes                  │
│                          │                             │
│ Type: NullReferenceExc   │ What were you doing?        │
│                          │ ┌─────────────────────────┐ │
│ Summary:                 │ │                         │ │
│ Database connection lost │ │ [User types here]       │ │
│                          │ │                         │ │
│ Technical:               │ │                         │ │
│ Connection timeout after │ │                         │ │
│ 30 seconds              │ │                         │ │
│                          │ │                         │ │
│                          │ └─────────────────────────┘ │
│                          │                             │
│                          │    [Submit]    [Cancel]     │
└──────────────────────────┴─────────────────────────────┘
```

**OPTION C: Two-Step Wizard**
```
Step 1: Review Error
┌─────────────────────────────────────────────┐
│ Report Error - Step 1 of 2              [X] │
├─────────────────────────────────────────────┤
│ Please review the error details:            │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ Error Type: DatabaseConnectionError     │ │
│ │                                         │ │
│ │ Summary: Connection to database lost    │ │
│ │                                         │ │
│ │ Technical Details: [Expandable...]      │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│                   [Next >]    [Cancel]      │
└─────────────────────────────────────────────┘

Step 2: Add Context
┌─────────────────────────────────────────────┐
│ Report Error - Step 2 of 2              [X] │
├─────────────────────────────────────────────┤
│ Help us understand what happened:           │
│                                             │
│ What were you doing when this error         │
│ occurred?                                   │
│ ┌─────────────────────────────────────────┐ │
│ │                                         │ │
│ │ [User types context here]               │ │
│ │                                         │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│         [< Back]  [Submit]    [Cancel]      │
└─────────────────────────────────────────────┘
```

***Create More Options (with the 3 above Options also create at least 5 more, this clarrifcation should be in its own file)***

```

---

## Configuration

Add to `Model_AppVariables` or appsettings.json:

```json
{
  "ErrorReporting": {
    "QueueDirectory": "%APPDATA%\\MTM_Application\\ErrorReports\\Pending\\",
    "ArchiveDirectory": "%APPDATA%\\MTM_Application\\ErrorReports\\Sent\\",
    "MaxPendingAgeDays": 30,
    "EnableAutoSyncOnStartup": true,
    "SyncProgressThreshold": 5,
    "MaxRetriesPerFile": 3,
    "TransactionTimeoutSeconds": 30
  }
}
```

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Users can successfully submit error reports with contextual notes in under 30 seconds
- **SC-002**: 100% of offline error reports are queued and successfully submitted on next connection
- **SC-003**: Sequential sync processing prevents database lock conflicts (0 deadlock errors)
- **SC-004**: Application startup time increases by less than 500ms even with 10 pending reports
- **SC-005**: Error report submission success rate exceeds 99% (excluding permanent network failures)
- **SC-006**: User notes are captured in 80% of submitted error reports (indicates good UX)
- **SC-007**: Pending report queue cleanup removes reports older than configured age within 24 hours

---

## Relevant Instruction Files

### For Implementation Phase:
- `.github/instructions/csharp-dotnet8.instructions.md` - Async/await patterns, WinForms event handling
- `.github/instructions/mysql-database.instructions.md` - Stored procedure standards, transaction management
- `.github/instructions/testing-standards.instructions.md` - Manual validation approach

### For Quality Assurance:
- `.github/instructions/security-best-practices.instructions.md` - SQL injection prevention, file system security
- `.github/instructions/performance-optimization.instructions.md` - Background thread usage, async I/O
- `.github/instructions/code-review-standards.instructions.md` - Review checklist for new features
