using MTM_WIP_Application_Winforms.Controls.Transactions;
using MTM_WIP_Application_Winforms.Core;
using MTM_WIP_Application_Winforms.Models;
using MTM_WIP_Application_Winforms.Services;

namespace MTM_WIP_Application_Winforms.Forms.Transactions;

/// <summary>
/// Transaction viewer form using modular UserControl architecture.
/// Refactored from 2136-line monolithic implementation to clean separation of concerns.
/// </summary>
/// <remarks>
/// Architecture:
/// - TransactionSearchControl: Handles all search criteria input
/// - TransactionGridControl: Handles grid display and pagination
/// - TransactionViewModel: Orchestrates data operations and business logic
/// 
/// This form acts as a thin coordinator, wiring up events between controls and viewmodel.
/// </remarks>
internal partial class Transactions : Form
{
    #region Fields

    private readonly TransactionViewModel _viewModel;
    private readonly string _currentUser;
    private readonly bool _isAdmin;

    #endregion

    #region Properties

    /// <summary>
    /// Gets whether the current user has admin privileges.
    /// </summary>
    public bool IsAdmin => _isAdmin;

    /// <summary>
    /// Gets the current user name.
    /// </summary>
    public string CurrentUser => _currentUser;

    #endregion

    #region Constructors

    /// <summary>
    /// Initializes a new instance of the <see cref="Transactions"/> form.
    /// </summary>
    /// <param name="connectionString">Database connection string (not used - DAOs handle connections)</param>
    /// <param name="currentUser">Current logged-in user name</param>
    public Transactions(string connectionString, string currentUser)
    {
        InitializeComponent();

        // Apply comprehensive DPI scaling and runtime layout adjustments
        AutoScaleMode = AutoScaleMode.Dpi;
        Core_Themes.ApplyDpiScaling(this);
        Core_Themes.ApplyRuntimeLayoutAdjustments(this);

        _currentUser = currentUser ?? throw new ArgumentNullException(nameof(currentUser));
        _isAdmin = Model_AppVariables.UserTypeAdmin;
        _viewModel = new TransactionViewModel();

        WireUpEvents();
        InitializeAsync().ConfigureAwait(false);
    }

    #endregion

    #region Initialization

    /// <summary>
    /// Wires up event handlers between controls.
    /// </summary>
    private void WireUpEvents()
    {
        // Search control events
        searchControl.SearchRequested += SearchControl_SearchRequested;
        searchControl.ResetRequested += SearchControl_ResetRequested;

        // Grid control events
        gridControl.PageChanged += GridControl_PageChanged;
        gridControl.RowSelected += GridControl_RowSelected;

        // Form events
        this.Load += Transactions_Load;
    }

    /// <summary>
    /// Asynchronously initializes form data (dropdowns, etc.).
    /// </summary>
    private async Task InitializeAsync()
    {
        try
        {
            // Load dropdown data in parallel
            var partsTask = _viewModel.LoadPartsAsync();
            var usersTask = _viewModel.LoadUsersAsync(_currentUser, _isAdmin);

            await Task.WhenAll(partsTask, usersTask).ConfigureAwait(false);

            // Update UI on UI thread
            this.Invoke(() =>
            {
                if (partsTask.Result.IsSuccess)
                {
                    searchControl.LoadParts(partsTask.Result.Data ?? new List<string>());
                }

                if (usersTask.Result.IsSuccess)
                {
                    searchControl.LoadUsers(usersTask.Result.Data ?? new List<string>());
                }
            });
        }
        catch (Exception ex)
        {
            Service_ErrorHandler.HandleException(
                ex,
                ErrorSeverity.Medium,
                retryAction: null, // Cannot retry initialization from error handler
                contextData: new Dictionary<string, object>
                {
                    ["User"] = _currentUser,
                    ["IsAdmin"] = _isAdmin
                },
                controlName: nameof(Transactions)
            );
        }
    }

    #endregion

    #region Event Handlers - Form

    /// <summary>
    /// Handles form load event.
    /// </summary>
    private void Transactions_Load(object? sender, EventArgs e)
    {
        // Initial load complete - form is ready
        this.Text = $"Transaction Viewer - {_currentUser}" + (_isAdmin ? " (Admin)" : "");
    }

    #endregion

    #region Event Handlers - Search Control

    /// <summary>
    /// Handles search request from search control.
    /// </summary>
    private async void SearchControl_SearchRequested(object? sender, TransactionSearchCriteria criteria)
    {
        try
        {
            // Execute search
            var result = await _viewModel.SearchTransactionsAsync(
                criteria,
                _currentUser,
                _isAdmin,
                page: 1 // Always start at page 1 for new search
            ).ConfigureAwait(false);

            // Update grid on UI thread
            this.Invoke(() =>
            {
                if (result.IsSuccess && result.Data != null)
                {
                    gridControl.DisplayResults(result.Data);
                }
                else
                {
                    Service_ErrorHandler.HandleValidationError(
                        result.ErrorMessage ?? "Search failed",
                        "Search"
                    );
                }
            });
        }
        catch (Exception ex)
        {
            Service_ErrorHandler.HandleException(
                ex,
                ErrorSeverity.Medium,
                retryAction: null, // Cannot retry event handler from error handler
                contextData: new Dictionary<string, object>
                {
                    ["Criteria"] = criteria.ToString()
                },
                controlName: nameof(searchControl)
            );
        }
    }

    /// <summary>
    /// Handles reset request from search control.
    /// </summary>
    private void SearchControl_ResetRequested(object? sender, EventArgs e)
    {
        // Clear grid
        gridControl.ClearResults();
    }

    #endregion

    #region Event Handlers - Grid Control

    /// <summary>
    /// Handles page change request from grid control.
    /// </summary>
    private async void GridControl_PageChanged(object? sender, int newPage)
    {
        try
        {
            // Use last search criteria, just change the page
            if (_viewModel.CurrentCriteria == null)
            {
                return; // No search has been performed yet
            }

            var result = await _viewModel.SearchTransactionsAsync(
                _viewModel.CurrentCriteria,
                _currentUser,
                _isAdmin,
                page: newPage
            ).ConfigureAwait(false);

            // Update grid on UI thread
            this.Invoke(() =>
            {
                if (result.IsSuccess && result.Data != null)
                {
                    gridControl.DisplayResults(result.Data);
                }
                else
                {
                    Service_ErrorHandler.HandleValidationError(
                        result.ErrorMessage ?? "Failed to load page",
                        "Pagination"
                    );
                }
            });
        }
        catch (Exception ex)
        {
            Service_ErrorHandler.HandleException(
                ex,
                ErrorSeverity.Medium,
                retryAction: null, // Cannot retry event handler from error handler
                contextData: new Dictionary<string, object>
                {
                    ["Page"] = newPage
                },
                controlName: nameof(gridControl)
            );
        }
    }

    /// <summary>
    /// Handles row selection in grid control.
    /// </summary>
    private void GridControl_RowSelected(object? sender, Model_Transactions transaction)
    {
        // Could show detail view, enable edit/delete buttons, etc.
        // For now, just log the selection
        if (transaction != null)
        {
            this.Text = $"Transaction Viewer - Selected: {transaction.TransactionType} #{transaction.ID}";
        }
    }

    #endregion

    #region Cleanup

    /// <summary>
    /// Cleans up resources used by the form.
    /// </summary>
    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            components?.Dispose();
            
            // Unwire events to prevent memory leaks
            if (searchControl != null)
            {
                searchControl.SearchRequested -= SearchControl_SearchRequested;
                searchControl.ResetRequested -= SearchControl_ResetRequested;
            }

            if (gridControl != null)
            {
                gridControl.PageChanged -= GridControl_PageChanged;
                gridControl.RowSelected -= GridControl_RowSelected;
            }
        }

        base.Dispose(disposing);
    }

    #endregion
}
