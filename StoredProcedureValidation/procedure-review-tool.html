<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stored Procedure Transaction Analysis Review Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 14px;
            color: #495057;
        }

        select, input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #495057;
            margin-left: auto;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .content {
            padding: 30px;
        }

        .procedure-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            overflow: hidden;
            word-wrap: break-word;
        }

        .procedure-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .procedure-name {
            font-size: 22px;
            font-weight: 700;
            color: #212529;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-domain {
            background: #e7f3ff;
            color: #0056b3;
        }

        .badge-pattern-readonly {
            background: #d4edda;
            color: #155724;
        }

        .badge-pattern-single {
            background: #cce5ff;
            color: #004085;
        }

        .badge-pattern-multi-seq {
            background: #fff3cd;
            color: #856404;
        }

        .badge-pattern-multi-cond {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-confidence-95 {
            background: #d4edda;
            color: #155724;
        }

        .badge-confidence-90 {
            background: #cce5ff;
            color: #004085;
        }

        .badge-confidence-85 {
            background: #fff3cd;
            color: #856404;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-value {
            font-size: 16px;
            color: #212529;
            font-weight: 600;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: relative;
            flex-shrink: 0;
        }

        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 125%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: normal;
            white-space: normal;
            width: 250px;
            text-transform: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            line-height: 1.4;
        }

        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 115%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2c3e50;
            z-index: 1001;
        }

        .dml-operations {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .dml-badge {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dml-insert {
            background: #d4edda;
            color: #155724;
        }

        .dml-update {
            background: #cce5ff;
            color: #004085;
        }

        .dml-delete {
            background: #f8d7da;
            color: #721c24;
        }

        .dml-total {
            background: #e2e3e5;
            color: #383d41;
        }

        .flags {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .flag {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .flag-true {
            background: #d4edda;
            color: #155724;
        }

        .flag-false {
            background: #f8d7da;
            color: #721c24;
        }

        .rationale-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            overflow: hidden;
            word-wrap: break-word;
        }

        .rationale-section h3 {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .rationale-content {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #212529;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            overflow-x: auto;
        }

        .edit-section {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            border: 2px solid #667eea;
        }

        .edit-section h3 {
            font-size: 16px;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .review-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .review-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .review-checkbox label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .keyboard-hint {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }

        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .arrow {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .navigation {
                flex-direction: column;
                gap: 15px;
            }

            .progress-info {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 6px;
            margin: 20px;
        }

        /* View SQL Button */
        .view-sp-button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-sp-button:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        /* SQL Modal */
        .sql-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .sql-modal-content {
            background: white;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .sql-modal-header {
            padding: 20px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sql-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #212529;
            font-family: 'Courier New', monospace;
        }

        .sql-modal-close {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sql-modal-close:hover {
            background: #c82333;
        }

        .sql-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .sql-code {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #212529;
        }

        .sql-loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 16px;
        }

        .sql-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Tree View Styles - v3.0 - Ultra Compact with display:block */
        .tree-view {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
            line-height: 1;
            margin: 0;
            padding: 0;
        }

        .tree-view *,
        .tree-view ul,
        .tree-view li {
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            list-style: none !important;
        }

        .tree-node {
            margin: 0 !important;
            padding: 0 !important;
            list-style: none;
            display: block !important;
        }

        .tree-node li {
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
        }

        .tree-node ul {
            margin: 0 !important;
            margin-left: 12px !important;
            padding: 0 !important;
            list-style: none;
            border-left: 1px solid #e9ecef;
            display: block !important;
        }

        .tree-item {
            position: relative;
            padding: 0px 4px !important;
            margin: 0 !important;
            cursor: default;
            display: flex !important;
            align-items: center;
            gap: 4px;
            min-height: 16px;
            line-height: 16px;
        }

        .tree-toggle {
            cursor: pointer;
            user-select: none;
            width: 14px;
            height: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #667eea;
            color: white;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .tree-toggle:hover {
            background: #5568d3;
        }

        .tree-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .tree-icon {
            flex-shrink: 0;
            font-size: 12px;
        }

        .tree-label {
            flex: 1;
            word-break: break-word;
        }

        .tree-children {
            transition: max-height 0.3s ease;
        }

        .tree-children.collapsed {
            display: none;
        }

        .tree-badge {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: #e9ecef;
            color: #495057;
        }

        .tree-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .tree-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Stored Procedure Transaction Analysis Review Tool</h1>
            <p>Review and correct the automated analysis of 75 stored procedures</p>
        </div>

        <div class="file-loader" id="fileLoader" style="background: #f8f9fa; padding: 30px; text-align: center; border-bottom: 1px solid #dee2e6;">
            <h3 style="margin-bottom: 15px; color: #495057;">üìÇ Load CSV File</h3>
            <p style="margin-bottom: 20px; color: #6c757d;">Select the procedure-transaction-analysis.csv file to begin review</p>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
            <button class="btn-primary" onclick="document.getElementById('csvFileInput').click()" style="font-size: 16px; padding: 12px 24px;">
                Choose CSV File
            </button>
            <p style="margin-top: 15px; font-size: 12px; color: #6c757d; font-style: italic;">
                Or drag and drop the CSV file anywhere on this page
            </p>
        </div>

        <div class="controls" style="display: none;">
            <div class="controls-row">
                <div class="control-group">
                    <label for="domainFilter">Domain:</label>
                    <select id="domainFilter">
                        <option value="">All Domains</option>
                        <option value="inventory">Inventory</option>
                        <option value="logging">Logging</option>
                        <option value="master-data">Master Data</option>
                        <option value="system">System</option>
                        <option value="users">Users</option>
                        <option value="uncategorized">Uncategorized</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="patternFilter">Pattern:</label>
                    <select id="patternFilter">
                        <option value="">All Patterns</option>
                        <option value="READ_ONLY">Read Only</option>
                        <option value="SINGLE_STEP">Single Step</option>
                        <option value="MULTI_STEP_SEQUENTIAL">Multi-Step Sequential</option>
                        <option value="MULTI_STEP_CONDITIONAL">Multi-Step Conditional</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="confidenceFilter">Confidence:</label>
                    <select id="confidenceFilter">
                        <option value="">All Confidence</option>
                        <option value="95">95% - High</option>
                        <option value="90">90% - Good</option>
                        <option value="85">85% - Moderate</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="reviewFilter">Review Status:</label>
                    <select id="reviewFilter">
                        <option value="">All</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="unreviewed">Unreviewed</option>
                    </select>
                </div>

                <div class="progress-info">
                    <span id="progressText">0 of 0 reviewed</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="controls-row">
                <div class="control-group">
                    <label for="searchBox">Search:</label>
                    <input type="text" id="searchBox" placeholder="Search procedure name..." style="width: 300px;">
                </div>

                <div class="control-group">
                    <label for="jumpTo">Jump to:</label>
                    <select id="jumpTo"></select>
                </div>

                <button class="btn-success" onclick="exportCSV()">üíæ Export CSV</button>
                <button class="btn-warning" onclick="saveProgress()">üì• Save Progress</button>
                <button class="btn-info" onclick="loadProgress()">üì§ Load Progress</button>
            </div>
        </div>

        <div class="content" id="content">
            <div class="loading">Loading CSV data...</div>
        </div>
    </div>

    <!-- SQL Modal -->
    <div id="sqlModal" class="sql-modal">
        <div class="sql-modal-content">
            <div class="sql-modal-header">
                <h2 id="sqlModalTitle">Stored Procedure</h2>
                <button class="sql-modal-close" onclick="closeSqlModal()">‚úï Close</button>
            </div>
            <div class="sql-modal-body">
                <div id="sqlModalContent" class="sql-loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let allProcedures = [];
        let filteredProcedures = [];
        let currentIndex = 0;
        let reviewedProcedures = new Set();
        let spSettings = null;
        let storedProceduresBasePath = 'UpdatedStoredProcedures/ReadyForVerification'; // Correct path relative to web server root

        // Load SPSettings.json on page load (silently fail for file:// protocol)
        async function loadSettings() {
            // Check if we're running on file:// protocol
            if (window.location.protocol === 'file:') {
                console.info('Running from file:// protocol - using default paths (UpdatedStoredProcedures/ReadyForVerification folder)');
                return;
            }
            
            try {
                const response = await fetch('./SPSettings.json');
                if (response.ok) {
                    spSettings = await response.json();
                    // Convert backslashes to forward slashes for web paths
                    const spPath = spSettings.Paths.StoredProceduresFolder.replace(/\\/g, '/');
                    storedProceduresBasePath = spPath;
                    console.log('Loaded SPSettings.json, SP path:', storedProceduresBasePath);
                } else {
                    console.info('SPSettings.json not found, using default path');
                }
            } catch (error) {
                console.info('Could not load SPSettings.json, using default path:', error.message);
            }
        }

        // Handle file input
        document.addEventListener('DOMContentLoaded', async function() {
            // Load settings first
            await loadSettings();
            
            const fileInput = document.getElementById('csvFileInput');
            const fileLoader = document.getElementById('fileLoader');
            const controls = document.querySelector('.controls');
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    loadCSVFile(file);
                }
            });

            // Drag and drop support
            document.body.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.body.style.opacity = '0.8';
            });

            document.body.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.body.style.opacity = '1';
            });

            document.body.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.body.style.opacity = '1';
                
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    loadCSVFile(file);
                } else {
                    alert('Please drop a CSV file');
                }
            });
        });

        function loadCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
                // Hide file loader, show controls
                document.getElementById('fileLoader').style.display = 'none';
                document.querySelector('.controls').style.display = 'block';
            };
            reader.onerror = function(e) {
                alert('Error reading file: ' + e.target.error);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            allProcedures = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                // Handle CSV with quoted fields
                const values = parseCSVLine(lines[i]);
                const procedure = {};
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    // Unescape doubled quotes (CSV standard for escaping quotes within quoted fields)
                    value = value.replace(/""/g, '"');
                    procedure[header] = value;
                });
                
                // Add review status
                procedure.reviewed = false;
                allProcedures.push(procedure);
            }

            filteredProcedures = [...allProcedures];
            updateJumpToDropdown();
            renderProcedure();
            updateProgress();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function renderProcedure() {
            if (filteredProcedures.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="loading">No procedures match the current filters.</div>
                `;
                return;
            }

            const proc = filteredProcedures[currentIndex];
            const isReviewed = reviewedProcedures.has(proc.ProcedureName);
            
            const patternClass = proc.DetectedPattern.toLowerCase().replace(/_/g, '-');
            const confidenceClass = `badge-confidence-${proc.Confidence}`;
            
            // Format confidence display - handle both numeric (85) and text (High/Medium/Low) values
            const confidenceDisplay = isNaN(proc.Confidence) ? `${proc.Confidence} Confidence` : `${proc.Confidence}% Confidence`;

            document.getElementById('content').innerHTML = `
                <div class="procedure-card">
                    <div class="procedure-header">
                        <div>
                            <div class="procedure-name" style="cursor: pointer; text-decoration: underline;" onclick="showStoredProcedure('${proc.ProcedureName}')" title="Click to view SQL file">${proc.ProcedureName}</div>
                            <div style="margin-top: 10px;">
                                <span class="badge badge-domain">${proc.Domain}</span>
                                <span class="badge badge-pattern-${patternClass}">${proc.DetectedPattern}</span>
                                <span class="badge ${confidenceClass}">${confidenceDisplay}</span>
                            </div>
                        </div>
                        <button onclick="showStoredProcedure('${proc.ProcedureName}')" class="view-sp-button">
                            üìÑ View SQL
                        </button>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">
                                Recommended Strategy
                                <span class="tooltip-icon" data-tooltip="Suggested transaction handling approach based on the procedure's complexity and data operations">?</span>
                            </div>
                            <div class="info-value">${proc.RecommendedStrategy}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                Procedure Type
                                <span class="tooltip-icon" data-tooltip="Classification of what the procedure does: SELECT_ONLY (read-only), DML_ONLY (insert/update/delete), or MIXED (queries + modifications)">?</span>
                            </div>
                            <div class="info-value">${proc.ProcedureType}</div>
                        </div>
                    </div>

                    <div class="dml-operations">
                        <div class="dml-badge dml-insert">
                            <span>INSERT 
                                <span class="tooltip-icon" data-tooltip="Number of INSERT statements that add new records to tables" style="background: #155724; margin-left: 4px;">?</span>
                            </span>
                            <span>${proc.InsertCount}</span>
                            ${proc.InsertTables && proc.InsertTables !== '' ? `
                                <div class="table-details" style="font-size: 0.75em; margin-top: 4px; opacity: 0.9;">
                                    <span class="tooltip-icon" data-tooltip="${proc.InsertTables}" style="background: #155724; padding: 2px 6px; cursor: help;">üìä</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="dml-badge dml-update">
                            <span>UPDATE 
                                <span class="tooltip-icon" data-tooltip="Number of UPDATE statements that modify existing records" style="background: #004085; margin-left: 4px;">?</span>
                            </span>
                            <span>${proc.UpdateCount}</span>
                            ${proc.UpdateTables && proc.UpdateTables !== '' ? `
                                <div class="table-details" style="font-size: 0.75em; margin-top: 4px; opacity: 0.9;">
                                    <span class="tooltip-icon" data-tooltip="${proc.UpdateTables}" style="background: #004085; padding: 2px 6px; cursor: help;">üìä</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="dml-badge dml-delete">
                            <span>DELETE 
                                <span class="tooltip-icon" data-tooltip="Number of DELETE statements that remove records from tables" style="background: #721c24; margin-left: 4px;">?</span>
                            </span>
                            <span>${proc.DeleteCount}</span>
                            ${proc.DeleteTables && proc.DeleteTables !== '' ? `
                                <div class="table-details" style="font-size: 0.75em; margin-top: 4px; opacity: 0.9;">
                                    <span class="tooltip-icon" data-tooltip="${proc.DeleteTables}" style="background: #721c24; padding: 2px 6px; cursor: help;">üìä</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="dml-badge dml-total">
                            <span>TOTAL 
                                <span class="tooltip-icon" data-tooltip="Combined count of all data modification operations (INSERT + UPDATE + DELETE)" style="background: #383d41; margin-left: 4px;">?</span>
                            </span>
                            <span>${proc.TotalDMLOps}</span>
                        </div>
                    </div>

                    <div class="flags">
                        <div class="flag ${(proc.HasTransactionHandling === 'True' || proc.HasTransactionHandling === 'Yes') ? 'flag-true' : 'flag-false'}">
                            ${(proc.HasTransactionHandling === 'True' || proc.HasTransactionHandling === 'Yes') ? '‚úì' : '‚úó'} Transaction Handling
                            <span class="tooltip-icon" data-tooltip="Whether the procedure uses explicit transactions (START TRANSACTION, COMMIT, ROLLBACK) to ensure data integrity" style="margin-left: 6px;">?</span>
                        </div>
                        <div class="flag ${(proc.HasValidation === 'True' || proc.HasValidation === 'Yes') ? 'flag-true' : 'flag-false'}">
                            ${(proc.HasValidation === 'True' || proc.HasValidation === 'Yes') ? '‚úì' : '‚úó'} Validation
                            <span class="tooltip-icon" data-tooltip="Whether the procedure validates input parameters before executing operations" style="margin-left: 6px;">?</span>
                        </div>
                    </div>

                    <div class="rationale-section">
                        <h3>Detected Operation Sequence 
                            <span class="tooltip-icon" data-tooltip="Step-by-step breakdown of what operations the procedure performs and in what order" style="background: #495057;">?</span>
                        </h3>
                        <div class="rationale-content">${formatRationale(proc.Rationale)}</div>
                    </div>

                    ${proc.CallHierarchy && proc.CallHierarchy !== '' ? `
                    <div class="rationale-section" style="border: 2px solid #667eea;">
                        <h3>üìû Call Hierarchy (UI ‚Üí DAO ‚Üí Stored Procedure) 
                            <span class="tooltip-icon" data-tooltip="Traces how this stored procedure is called from the user interface, through intermediate methods, to the data access layer" style="background: #495057;">?</span>
                        </h3>
                        <div class="rationale-content">${formatCallHierarchy(proc.CallHierarchy)}</div>
                    </div>
                    ` : ''}

                    <div class="edit-section">
                        <h3>‚úèÔ∏è Review & Corrections</h3>
                        
                        <div class="form-group">
                            <label for="developerCorrection">
                                Developer Correction 
                                <span class="tooltip-icon" data-tooltip="Override the automatically detected pattern if the analysis is incorrect. Leave blank if the detection is accurate." style="background: #495057; margin-left: 6px;">?</span>
                            </label>
                            <input type="text" id="developerCorrection" 
                                   value="${proc.DeveloperCorrection || ''}"
                                   placeholder="e.g., Should be MULTI_STEP_SEQUENTIAL instead"
                                   onchange="updateProcedure('DeveloperCorrection', this.value)">
                        </div>

                        <div class="form-group">
                            <label for="notes">
                                Notes 
                                <span class="tooltip-icon" data-tooltip="Add any observations, questions, or additional context about this procedure for future reference" style="background: #495057; margin-left: 6px;">?</span>
                            </label>
                            <textarea id="notes" 
                                      onchange="updateProcedure('Notes', this.value)"
                                      placeholder="Add any notes, questions, or observations about this procedure...">${proc.Notes || ''}</textarea>
                        </div>

                        <div class="review-checkbox">
                            <input type="checkbox" id="reviewedCheck" 
                                   ${isReviewed ? 'checked' : ''}
                                   onchange="toggleReviewed()">
                            <label for="reviewedCheck">
                                Mark as Reviewed 
                                <span class="tooltip-icon" data-tooltip="Check this box once you've reviewed and verified the procedure analysis" style="background: #495057; margin-left: 6px;">?</span>
                            </label>
                        </div>
                        
                        <div class="review-checkbox" style="background: #fff3cd; border: 1px solid #ffc107;">
                            <input type="checkbox" id="needsAttentionCheck" 
                                   ${proc.NeedsAttention === 'True' || proc.NeedsAttention === 'true' ? 'checked' : ''}
                                   onchange="toggleNeedsAttention()">
                            <label for="needsAttentionCheck" style="color: #856404;">
                                ‚ö†Ô∏è Needs Attention 
                                <span class="tooltip-icon" data-tooltip="Automatically checked when Developer Correction or Notes are added. Indicates this procedure requires validation, testing, or correction" style="background: #856404; margin-left: 6px;">?</span>
                            </label>
                        </div>
                    </div>

                    <div class="navigation">
                        <div class="nav-buttons">
                            <button class="btn-secondary" onclick="previousProcedure()" ${currentIndex === 0 ? 'disabled' : ''}>
                                <span class="arrow">‚Üê</span> Previous
                            </button>
                            <button class="btn-primary" onclick="nextProcedure()" ${currentIndex === filteredProcedures.length - 1 ? 'disabled' : ''}>
                                Next <span class="arrow">‚Üí</span>
                            </button>
                        </div>
                        <div style="text-align: center;">
                            <strong>Procedure ${currentIndex + 1} of ${filteredProcedures.length}</strong>
                            <div class="keyboard-hint">Use arrow keys to navigate</div>
                        </div>
                        <div class="nav-buttons">
                            <button class="btn-secondary" onclick="jumpToFirst()">‚èÆ First</button>
                            <button class="btn-secondary" onclick="jumpToLast()">Last ‚è≠</button>
                        </div>
                    </div>
                </div>

                <div class="export-section">
                    <h3>üìä Review Statistics</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${reviewedProcedures.size}</div>
                            <div class="stat-label">Reviewed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${allProcedures.length - reviewedProcedures.size}</div>
                            <div class="stat-label">Remaining</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${allProcedures.length}</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    <button class="btn-success" onclick="exportCSV()" style="margin-top: 15px;">
                        üíæ Export Reviewed CSV
                    </button>
                </div>
            `;
        }

        function formatRationale(rationale) {
            // Format the rationale to be more readable
            return rationale
                .replace(/‚Üí/g, '\n  ‚Üí')
                .replace(/\|/g, '\n|');
        }

        function formatCallHierarchy(hierarchyJson) {
            if (!hierarchyJson || hierarchyJson === '') {
                return '<div class="tree-view"><p style="color: #6c757d; font-style: italic;">No call hierarchy data available</p></div>';
            }
            
            try {
                // First check if it's already an object/array
                let hierarchy;
                if (typeof hierarchyJson === 'string') {
                    // Try to parse as JSON
                    hierarchy = JSON.parse(hierarchyJson);
                } else {
                    hierarchy = hierarchyJson;
                }
                
                // Handle case where hierarchy is not an array
                if (!Array.isArray(hierarchy)) {
                    return `<div class="tree-view">${buildTreeView(hierarchy)}</div>`;
                }
                
                if (hierarchy.length === 0) {
                    return '<div class="tree-view"><p style="color: #6c757d; font-style: italic;">No call hierarchy data available</p></div>';
                }
                
                // Filter out any invalid entries and deduplicate based on EventHandler
                const validHierarchies = [];
                const seenEventHandlers = new Set();
                
                for (const h of hierarchy) {
                    if (h && typeof h === 'object' && h.EventHandler) {
                        const key = JSON.stringify(h); // Use full object as key for true deduplication
                        if (!seenEventHandlers.has(key)) {
                            seenEventHandlers.add(key);
                            validHierarchies.push(h);
                        }
                    }
                }
                
                if (validHierarchies.length === 0) {
                    return '<div class="tree-view"><p style="color: #6c757d; font-style: italic;">No call hierarchy data available</p></div>';
                }
                
                // Build trees for each valid hierarchy
                const trees = validHierarchies.map((h, idx) => {
                    return `
                        <div style="margin-bottom: 20px;">
                            ${idx > 0 ? '<hr style="border: none; border-top: 2px solid #dee2e6; margin: 20px 0;">' : ''}
                            ${buildTreeView(h)}
                        </div>
                    `;
                }).join('');
                
                return `<div class="tree-view">${trees}</div>`;
                
            } catch (e) {
                console.error('Error parsing hierarchy:', e);
                console.error('Raw hierarchy data:', hierarchyJson);
                console.error('Type:', typeof hierarchyJson);
                return `<div class="tree-view">
                    <p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Error parsing call hierarchy</p>
                    <p style="color: #6c757d; font-size: 0.9em; font-style: italic;">Error: ${e.message}</p>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #667eea;">Show raw data</summary>
                        <pre style="color: #6c757d; font-size: 0.85em; max-height: 200px; overflow: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">${hierarchyJson.substring(0, 500)}${hierarchyJson.length > 500 ? '...' : ''}</pre>
                    </details>
                </div>`;
            }
        }
        
        let treeNodeId = 0;
        
        function buildTreeView(h) {
            treeNodeId = 0;
            let html = '<ul class="tree-node">';
            
            if (h.Status === "Called from UI") {
                // Extract form name from event handler (e.g., "DependencyChartViewerForm.listHtmlFiles_SelectedIndexChanged")
                let formName = "Unknown Form";
                let eventName = h.EventHandler || "Unknown Event";

                if (h.EventHandler && h.EventHandler.includes('.')) {
                    const parts = h.EventHandler.split('.');
                    // Handle both "FileName.cs.MethodName" and "FileName.MethodName" formats
                    if (parts.length >= 3 && parts[1] === 'cs') {
                        formName = parts[0] + '.cs';
                        eventName = parts[2];
                    } else if (parts.length >= 2) {
                        formName = parts[0] + '.cs';
                        eventName = parts[1];
                    } else {
                        eventName = h.EventHandler;
                    }
                }                // Root: Form File
                const formId = `tree-${treeNodeId++}`;
                html += `<li><div class="tree-item"><span class="tree-toggle" onclick="toggleTreeNode('${formId}')">‚ñº</span><span class="tree-icon">ÔøΩ</span><span class="tree-label"><strong>${formName}</strong></span><span class="tree-badge">Entry Point</span></div><ul id="${formId}" class="tree-children">`;
                
                // Event Handler
                const eventId = `tree-${treeNodeId++}`;
                html += `<li><div class="tree-item"><span class="tree-toggle" onclick="toggleTreeNode('${eventId}')">‚ñº</span><span class="tree-icon">üéØ</span><span class="tree-label">${eventName}</span></div><ul id="${eventId}" class="tree-children">`;
                
                // DAO Layer
                if (h.DAO) {
                    const daoFileId = `tree-${treeNodeId++}`;
                    html += `<li><div class="tree-item"><span class="tree-toggle" onclick="toggleTreeNode('${daoFileId}')">‚ñº</span><span class="tree-icon">ÔøΩ</span><span class="tree-label"><strong>${h.DAO.File}</strong></span></div><ul id="${daoFileId}" class="tree-children">`;
                    
                    // DAO Method
                    const daoMethodId = `tree-${treeNodeId++}`;
                    html += `<li><div class="tree-item"><span class="tree-toggle" onclick="toggleTreeNode('${daoMethodId}')">‚ñº</span><span class="tree-icon">‚öôÔ∏è</span><span class="tree-label">${h.DAO.Method}</span></div><ul id="${daoMethodId}" class="tree-children">`;
                    
                    // Stored Procedure
                    if (h.StoredProcedure) {
                        const spId = `tree-${treeNodeId++}`;
                        html += `<li><div class="tree-item"><span class="tree-toggle" onclick="toggleTreeNode('${spId}')">‚ñº</span><span class="tree-icon">üóÑÔ∏è</span><span class="tree-label"><a href="#" onclick="event.preventDefault(); showStoredProcedure('${h.StoredProcedure}'); return false;" style="color: #667eea; text-decoration: none; cursor: pointer;">${h.StoredProcedure}</a></span></div><ul id="${spId}" class="tree-children">`;
                        
                        // Tables
                        if (h.Tables) {
                            let tables = Array.isArray(h.Tables) ? h.Tables : [h.Tables];
                            tables = tables.filter(t => t && t !== '');
                            
                            if (tables.length > 0) {
                                tables.forEach(table => {
                                    html += `<li><div class="tree-item"><span class="tree-icon">üìã</span><span class="tree-label">${table}</span></div></li>`;
                                });
                            }
                        }
                        
                        html += `</ul></li>`; // Close stored procedure
                    }
                    
                    html += `</ul></li>`; // Close DAO method
                    html += `</ul></li>`; // Close DAO file
                }
                
                html += `</ul></li>`; // Close event handler
                html += `</ul></li>`; // Close form file
                
            } else if (h.Status === "Called from DAO (no UI event handler traced)") {
                // DAO without UI
                if (h.DAO) {
                    const daoId = `tree-${treeNodeId++}`;
                    html += `<li><div class="tree-item"><span class="tree-toggle" onclick="toggleTreeNode('${daoId}')">‚ñº</span><span class="tree-icon">üíæ</span><span class="tree-label"><strong>DAO:</strong> ${h.DAO.File} - ${h.DAO.Method}</span><span class="tree-badge">No UI Trace</span></div><ul id="${daoId}" class="tree-children">`;
                    
                    if (h.StoredProcedure) {
                        html += `<li><div class="tree-item"><span class="tree-icon">üóÑÔ∏è</span><span class="tree-label"><strong>SP:</strong> <a href="#" onclick="event.preventDefault(); showStoredProcedure('${h.StoredProcedure}'); return false;" style="color: #667eea; text-decoration: none; cursor: pointer;">${h.StoredProcedure}</a></span></div></li>`;
                    }
                    
                    if (h.Tables && h.Tables.length > 0) {
                        html += `<li><div class="tree-item"><span class="tree-icon">üìä</span><span class="tree-label"><strong>Tables:</strong> ${h.Tables.join(', ')}</span></div></li>`;
                    }
                    
                    if (h.ReturnType && h.ReturnType !== 'Unknown') {
                        html += `<li><div class="tree-item"><span class="tree-icon">‚Ü©Ô∏è</span><span class="tree-label"><strong>Returns:</strong> ${h.ReturnType}</span></div></li>`;
                    }
                    
                    html += `</ul></li>`;
                }
                
            } else if (h.Status === "Not called from C# code") {
                html += `<li><div class="tree-item"><span class="tree-icon">‚ö†Ô∏è</span><span class="tree-label"><strong>Status:</strong> ${h.Status}</span><span class="tree-badge error">Legacy</span></div></li>`;
                
                if (h.StoredProcedure) {
                    html += `<li><div class="tree-item"><span class="tree-icon">üóÑÔ∏è</span><span class="tree-label"><strong>SP:</strong> <a href="#" onclick="event.preventDefault(); showStoredProcedure('${h.StoredProcedure}'); return false;" style="color: #667eea; text-decoration: none; cursor: pointer;">${h.StoredProcedure}</a></span></div></li>`;
                }
                
                if (h.Tables && h.Tables.length > 0) {
                    html += `<li><div class="tree-item"><span class="tree-icon">üìä</span><span class="tree-label"><strong>Tables:</strong> ${h.Tables.join(', ')}</span></div></li>`;
                }
                
                if (h.Note) {
                    html += `<li><div class="tree-item"><span class="tree-icon">üìù</span><span class="tree-label"><strong>Note:</strong> ${h.Note}</span></div></li>`;
                }
            } else {
                html += `<li><div class="tree-item"><span class="tree-icon">‚ùì</span><span class="tree-label"><strong>Status:</strong> ${h.Status || 'Unknown'}</span></div></li>`;
                
                if (h.Note) {
                    html += `<li><div class="tree-item"><span class="tree-icon">üìù</span><span class="tree-label"><strong>Note:</strong> ${h.Note}</span></div></li>`;
                }
            }
            
            html += '</ul>';
            return html;
        }
        
        function toggleTreeNode(nodeId) {
            const node = document.getElementById(nodeId);
            const toggle = event.target;
            
            if (node.classList.contains('collapsed')) {
                node.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                node.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }

        function updateProcedure(field, value) {
            const proc = filteredProcedures[currentIndex];
            proc[field] = value;
            
            // Update in allProcedures as well
            const allIndex = allProcedures.findIndex(p => p.ProcedureName === proc.ProcedureName);
            if (allIndex !== -1) {
                allProcedures[allIndex][field] = value;
            }
            
            // Auto-check "Needs Attention" if Developer Correction or Notes have content
            if (field === 'DeveloperCorrection' || field === 'Notes') {
                const devCorrection = proc.DeveloperCorrection || '';
                const notes = proc.Notes || '';
                
                if (devCorrection.trim() !== '' || notes.trim() !== '') {
                    proc.NeedsAttention = 'True';
                    if (allIndex !== -1) {
                        allProcedures[allIndex].NeedsAttention = 'True';
                    }
                    // Update checkbox if it exists
                    const checkbox = document.getElementById('needsAttentionCheck');
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                }
            }
        }

        function toggleReviewed() {
            const proc = filteredProcedures[currentIndex];
            if (reviewedProcedures.has(proc.ProcedureName)) {
                reviewedProcedures.delete(proc.ProcedureName);
            } else {
                reviewedProcedures.add(proc.ProcedureName);
            }
            updateProgress();
        }
        
        function toggleNeedsAttention() {
            const checked = document.getElementById('needsAttentionCheck').checked;
            updateProcedure('NeedsAttention', checked ? 'True' : 'False');
        }

        function updateProgress() {
            const total = allProcedures.length;
            const reviewed = reviewedProcedures.size;
            const percentage = Math.round((reviewed / total) * 100);
            
            document.getElementById('progressText').textContent = `${reviewed} of ${total} reviewed (${percentage}%)`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        function nextProcedure() {
            if (currentIndex < filteredProcedures.length - 1) {
                currentIndex++;
                renderProcedure();
            }
        }

        function previousProcedure() {
            if (currentIndex > 0) {
                currentIndex--;
                renderProcedure();
            }
        }

        function jumpToFirst() {
            currentIndex = 0;
            renderProcedure();
        }

        function jumpToLast() {
            currentIndex = filteredProcedures.length - 1;
            renderProcedure();
        }

        function applyFilters() {
            const domainFilter = document.getElementById('domainFilter').value;
            const patternFilter = document.getElementById('patternFilter').value;
            const confidenceFilter = document.getElementById('confidenceFilter').value;
            const reviewFilter = document.getElementById('reviewFilter').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();

            filteredProcedures = allProcedures.filter(proc => {
                if (domainFilter && proc.Domain !== domainFilter) return false;
                if (patternFilter && proc.DetectedPattern !== patternFilter) return false;
                if (confidenceFilter && proc.Confidence !== confidenceFilter) return false;
                if (reviewFilter === 'reviewed' && !reviewedProcedures.has(proc.ProcedureName)) return false;
                if (reviewFilter === 'unreviewed' && reviewedProcedures.has(proc.ProcedureName)) return false;
                if (searchText && !proc.ProcedureName.toLowerCase().includes(searchText)) return false;
                return true;
            });

            currentIndex = 0;
            updateJumpToDropdown();
            renderProcedure();
        }

        function updateJumpToDropdown() {
            const jumpTo = document.getElementById('jumpTo');
            jumpTo.innerHTML = filteredProcedures.map((proc, index) => 
                `<option value="${index}">${index + 1}. ${proc.ProcedureName}</option>`
            ).join('');
        }

        function exportCSV() {
            const headers = Object.keys(allProcedures[0]).filter(h => h !== 'reviewed');
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            
            allProcedures.forEach(proc => {
                const row = headers.map(header => {
                    const value = proc[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `procedure-transaction-analysis-reviewed-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function saveProgress() {
            const progressData = {
                version: '1.0',
                savedAt: new Date().toISOString(),
                currentIndex: currentIndex,
                reviewedProcedures: Array.from(reviewedProcedures),
                procedures: allProcedures.map(proc => ({
                    ProcedureName: proc.ProcedureName,
                    DeveloperCorrection: proc.DeveloperCorrection || '',
                    Notes: proc.Notes || '',
                    NeedsAttention: proc.NeedsAttention || 'False',
                    reviewed: proc.reviewed || false
                })),
                filters: {
                    domain: document.getElementById('domainFilter').value,
                    pattern: document.getElementById('patternFilter').value,
                    confidence: document.getElementById('confidenceFilter').value,
                    review: document.getElementById('reviewFilter').value,
                    search: document.getElementById('searchBox').value
                }
            };

            const blob = new Blob([JSON.stringify(progressData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `procedure-review-progress-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert(`‚úÖ Progress saved!\n\nProcedures reviewed: ${reviewedProcedures.size}\nEdited procedures: ${allProcedures.filter(p => p.DeveloperCorrection || p.Notes).length}\nCurrent position: ${currentIndex + 1} of ${filteredProcedures.length}`);
        }

        function loadProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const progressData = JSON.parse(event.target.result);
                        
                        // Validate version
                        if (!progressData.version || progressData.version !== '1.0') {
                            alert('‚ùå Invalid progress file format.');
                            return;
                        }

                        // Restore edits to matching procedures
                        let restoredCount = 0;
                        progressData.procedures.forEach(savedProc => {
                            const proc = allProcedures.find(p => p.ProcedureName === savedProc.ProcedureName);
                            if (proc) {
                                proc.DeveloperCorrection = savedProc.DeveloperCorrection || '';
                                proc.Notes = savedProc.Notes || '';
                                proc.NeedsAttention = savedProc.NeedsAttention || 'False';
                                proc.reviewed = savedProc.reviewed || false;
                                restoredCount++;
                            }
                        });

                        // Restore reviewed set
                        reviewedProcedures = new Set(progressData.reviewedProcedures || []);

                        // Restore filters
                        if (progressData.filters) {
                            document.getElementById('domainFilter').value = progressData.filters.domain || 'all';
                            document.getElementById('patternFilter').value = progressData.filters.pattern || 'all';
                            document.getElementById('confidenceFilter').value = progressData.filters.confidence || 'all';
                            document.getElementById('reviewFilter').value = progressData.filters.review || 'all';
                            document.getElementById('searchBox').value = progressData.filters.search || '';
                        }

                        // Apply filters and restore position
                        applyFilters();
                        currentIndex = Math.min(progressData.currentIndex || 0, filteredProcedures.length - 1);
                        renderProcedure();

                        alert(`‚úÖ Progress loaded!\n\nRestored: ${restoredCount} procedures\nReviewed: ${reviewedProcedures.size}\nSaved on: ${new Date(progressData.savedAt).toLocaleString()}`);
                    } catch (error) {
                        alert(`‚ùå Error loading progress file:\n${error.message}`);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Event listeners
        document.getElementById('domainFilter').addEventListener('change', applyFilters);
        document.getElementById('patternFilter').addEventListener('change', applyFilters);
        document.getElementById('confidenceFilter').addEventListener('change', applyFilters);
        document.getElementById('reviewFilter').addEventListener('change', applyFilters);
        document.getElementById('searchBox').addEventListener('input', applyFilters);
        document.getElementById('jumpTo').addEventListener('change', function() {
            currentIndex = parseInt(this.value);
            renderProcedure();
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                e.preventDefault();
                nextProcedure();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                e.preventDefault();
                previousProcedure();
            } else if (e.key === 'Home') {
                e.preventDefault();
                jumpToFirst();
            } else if (e.key === 'End') {
                e.preventDefault();
                jumpToLast();
            }
        });

        // SQL Modal Functions
        async function showStoredProcedure(procedureName) {
            const modal = document.getElementById('sqlModal');
            const title = document.getElementById('sqlModalTitle');
            const content = document.getElementById('sqlModalContent');
            
            title.textContent = procedureName;
            content.className = 'sql-loading';
            content.textContent = 'Loading stored procedure...';
            modal.style.display = 'flex';
            
            // Check if being served via file:// protocol
            const isFileProtocol = window.location.protocol === 'file:';
            
            try {
                // Build paths using the loaded settings or fallback
                const subfolders = [
                    'inventory', 'transactions', 'users', 'system', 'logging', 
                    'master-data', 'quick-buttons', 'roles', 'user-based', 'uncategorized'
                ];
                
                // Try with subfolder structure (storedProceduresBasePath already includes ReadyForVerification if needed)
                let paths = subfolders.map(subfolder => 
                    `${storedProceduresBasePath}/${subfolder}/${procedureName}.sql`
                );
                
                // Also try root of stored procedures folder
                paths.push(`${storedProceduresBasePath}/${procedureName}.sql`);
                
                let sqlContent = null;
                let successPath = null;
                let fetchError = null;
                
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            sqlContent = await response.text();
                            successPath = path;
                            break;
                        }
                    } catch (err) {
                        // Store first error for reporting
                        if (!fetchError) fetchError = err;
                        // Try next path
                        continue;
                    }
                }
                
                if (sqlContent) {
                    content.className = 'sql-code';
                    content.textContent = sqlContent;
                } else {
                    content.className = 'sql-error';
                    
                    // Provide helpful message based on protocol
                    if (isFileProtocol) {
                        content.innerHTML = `
                            <strong>‚ùå Cannot Load SQL Files via file:// Protocol</strong><br><br>
                            
                            <strong>Why this happens:</strong><br>
                            Browsers block loading local files when the HTML is opened directly (file://) due to security restrictions (CORS).<br><br>
                            
                            <strong>üîß Solution - Use the Web Server:</strong><br>
                            1. Open PowerShell in this folder<br>
                            2. Run: <code style="background: #2d2d2d; padding: 2px 6px; border-radius: 3px; color: #4ec9b0;">./Start-WebServer.ps1</code><br>
                            3. The page will open at <code style="background: #2d2d2d; padding: 2px 6px; border-radius: 3px; color: #4ec9b0;">http://localhost:8080</code> with SQL viewing enabled<br><br>
                            
                            <strong>üìÅ Manual Alternative:</strong><br>
                            Open the file directly from:<br>
                            <code style="background: #2d2d2d; padding: 4px 8px; border-radius: 3px; display: inline-block; margin-top: 8px; color: #ce9178;">
                            ${storedProceduresBasePath}/inventory/${procedureName}.sql
                            </code>
                        `;
                    } else {
                        content.innerHTML = `
                            <strong>‚ùå File Not Found</strong><br><br>
                            Could not locate <code>${procedureName}.sql</code><br><br>
                            Searched in:<br>
                            ${paths.map(p => `‚Ä¢ ${p}`).join('<br>')}
                            ${fetchError ? `<br><br><strong>Error:</strong> ${fetchError.message}` : ''}
                        `;
                    }
                }
            } catch (error) {
                content.className = 'sql-error';
                content.innerHTML = `
                    <strong>‚ùå Error Loading File</strong><br><br>
                    ${error.message}
                `;
            }
        }
        
        function closeSqlModal() {
            document.getElementById('sqlModal').style.display = 'none';
        }
        
        // Close modal on background click
        document.getElementById('sqlModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSqlModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSqlModal();
            }
        });
    </script>
</body>
</html>
