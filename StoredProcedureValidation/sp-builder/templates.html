<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedure Templates - MySQL 5.7 Stored Procedure Builder</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .templates-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .templates-header {
            margin-bottom: var(--spacing-xl);
        }

        .templates-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: var(--spacing-xl);
            align-items: start;
        }

        /* Category Sidebar */
        .category-sidebar {
            position: sticky;
            top: var(--spacing-xl);
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-item {
            margin-bottom: var(--spacing-sm);
        }

        .category-button {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--color-bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-button:hover {
            background: var(--color-bg-tertiary);
            border-color: var(--color-border);
        }

        .category-button.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .category-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
        }

        .category-button:not(.active) .category-badge {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
        }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-lg);
        }

        .template-card {
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: var(--color-primary);
            background: var(--color-bg-secondary);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }

        .template-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .template-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-xs);
        }

        .template-description {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-md);
            line-height: 1.5;
        }

        .template-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .template-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .tag {
            background: var(--color-bg-secondary);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .template-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            background: var(--color-success);
            color: white;
        }

        .template-badge.custom {
            background: var(--color-info);
        }

        .metadata-warning {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
        }


        /* Customization Panel */
        .customization-panel {
            position: fixed;
            right: -600px;
            top: 0;
            width: 600px;
            height: 100vh;
            background: #ffffff; /* Fallback */
            background: var(--color-bg, #ffffff);
            color: #1a1a1a; /* Ensure text is visible */
            color: var(--color-text, #1a1a1a);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            transition: right 0.3s;
            z-index: 1100; /* Higher than header (1020) and modals (1050) */
            overflow-y: auto;
        }

        .customization-panel.open {
            right: 0;
        }

        .panel-header {
            padding: var(--spacing-xl, 1.5rem);
            border-bottom: 1px solid var(--color-border, #e0e0e0);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #ffffff; /* Fallback */
            background: var(--color-bg, #ffffff);
            z-index: 10;
        }

        .panel-content {
            padding: var(--spacing-xl);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--spacing-sm);
        }

        .form-group label .required {
            color: var(--color-error);
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: var(--spacing-sm);
            border-radius: 50%;
            background-color: var(--color-bg-secondary);
            color: var(--color-primary);
            font-size: 0.75rem;
            cursor: help;
        }

        .info-icon:hover {
            background-color: var(--color-primary);
            color: #fff;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-md, 1rem);
            border: 1px solid var(--color-border, #e0e0e0);
            border-radius: var(--radius-md, 0.375rem);
            font-family: inherit;
            background: #ffffff; /* Ensure white background */
            color: #1a1a1a; /* Ensure dark text */
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .validation-warning {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-warning-bg);
            border-left: 4px solid var(--color-warning);
            border-radius: var(--radius-md);
        }

        .validation-warning h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--color-warning);
        }

        .suggestions-list {
            list-style: none;
            padding: 0;
            margin: var(--spacing-sm) 0 0 0;
        }

        .suggestions-list li {
            padding: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .suggestions-list li:hover {
            background: var(--color-bg-tertiary);
        }

        .panel-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xxl);
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="main-content">
        <div class="templates-container">
            <!-- Header -->
            <div class="templates-header">
                <h1>üìö Procedure Templates</h1>
                <p class="lead">Start quickly with pre-built templates for common stored procedure patterns.</p>
                
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                    <button id="btn-back-to-wizard" class="btn btn-secondary">
                        ‚Üê Back to Wizard
                    </button>
                    <button id="btn-save-as-template" class="btn btn-outline-primary">
                        üíæ Save Current as Template
                    </button>
                    <div style="flex: 1;"></div>
                    <input 
                        type="search" 
                        id="template-search" 
                        placeholder="Search templates..." 
                        style="padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-md); width: 300px;"
                    >
                </div>
            </div>

            <!-- Main Layout -->
            <div class="templates-layout">
                <!-- Category Sidebar -->
                <aside class="category-sidebar">
                    <h3>Categories</h3>
                    <ul class="category-list" id="category-list">
                        <!-- Populated by JavaScript -->
                    </ul>
                </aside>

                <!-- Template Grid -->
                <div>
                    <div id="template-grid" class="template-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <div id="empty-state" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No Templates Found</h3>
                        <p>Try selecting a different category or adjusting your search.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Customization Panel (Slide-in) -->
        <div id="customization-panel" class="customization-panel">
        <div class="panel-header">
            <div>
                <h2 id="panel-title">Customize Template</h2>
                <p id="panel-subtitle" style="color: var(--color-text-secondary); margin: 0;"></p>
            </div>
            <button id="btn-close-panel" class="btn btn-icon">‚úï</button>
        </div>
        
        <div class="panel-content">
            <form id="customization-form">
                <!-- Form fields populated dynamically -->
            </form>

            <div id="validation-warnings" style="display: none;"></div>

            <div class="panel-actions">
                <button id="btn-apply-template" class="btn btn-primary btn-lg" style="flex: 1;">
                    ‚úì Apply Template to Wizard
                </button>
                <button id="btn-cancel" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>
        </div>

        <!-- Overlay for panel -->
        <div id="panel-overlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1090;
        "></div>
    </main>

    <script type="module">
    import { templateManager } from './js/template-manager.js';
    import { storageManager } from './js/storage-manager.js';
    import { showSuccess, showError } from './js/utils.js';
    import { initNavigation } from './js/navigation.js';
    import { showLoading, hideLoading } from './js/loading.js';
    import { dbMetadata } from './js/database-metadata.js';

        // Initialize
        let selectedCategory = 'CRUD';
        let selectedTemplate = null;
        let searchTerm = '';

        const escapeHtml = (value = '') => `${value}`
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        let tableNames = [];
        let tableMetadataAvailable = false;
        let metadataErrorShown = false;

        async function ensureTableList() {
            if (dbMetadata.tables.length === 0 || dbMetadata.isStale()) {
                const result = await dbMetadata.fetchTables();

                if (!result.success && dbMetadata.tables.length === 0 && !metadataErrorShown) {
                    metadataErrorShown = true;
                    showError({
                        error_type: 'metadata',
                        user_message: 'Unable to load table list from the database. Start MAMP and refresh, or type the table name manually.',
                        technical_detail: result.error
                    });
                }
            }

            tableNames = (dbMetadata.tables || [])
                .map(t => t.name)
                .sort((a, b) => a.localeCompare(b));

            tableMetadataAvailable = tableNames.length > 0;
        }

        const renderCustomizationField = (point) => {
            const fieldId = `field-${point.key}`;
            const requiredAttr = point.required ? 'required' : '';
            const tooltipHtml = point.tooltip
                ? `<span class="info-icon" title="${escapeHtml(point.tooltip)}" aria-label="${escapeHtml(point.tooltip)}">‚ìò</span>`
                : '';
            const requiredHtml = point.required ? '<span class="required" aria-hidden="true">*</span>' : '';

            let inputHtml = '';

            switch (point.type) {
                case 'textarea':
                    inputHtml = `<textarea id="${fieldId}" ${requiredAttr}></textarea>`;
                    break;
                case 'table-select':
                    if (tableMetadataAvailable && tableNames.length > 0) {
                        const optionsHtml = tableNames
                            .map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`)
                            .join('');
                        inputHtml = `
                            <select id="${fieldId}" ${requiredAttr}>
                                <option value="">Select a table...</option>
                                ${optionsHtml}
                            </select>
                        `;
                    } else {
                        inputHtml = `
                            <div class="metadata-warning">Table list unavailable. Enter the table name manually.</div>
                            <input type="text" id="${fieldId}" ${requiredAttr} placeholder="Enter table name">
                        `;
                    }
                    break;
                default:
                    inputHtml = `<input type="${point.type || 'text'}" id="${fieldId}" ${requiredAttr}>`;
                    break;
            }

            return `
                <div class="form-group">
                    <label for="${fieldId}">
                        <span>${escapeHtml(point.label)}</span>
                        ${tooltipHtml}
                        ${requiredHtml}
                    </label>
                    ${inputHtml}
                </div>
            `;
        };

        const elements = {
            categoryList: document.getElementById('category-list'),
            templateGrid: document.getElementById('template-grid'),
            emptyState: document.getElementById('empty-state'),
            customizationPanel: document.getElementById('customization-panel'),
            panelOverlay: document.getElementById('panel-overlay'),
            panelTitle: document.getElementById('panel-title'),
            panelSubtitle: document.getElementById('panel-subtitle'),
            customizationForm: document.getElementById('customization-form'),
            validationWarnings: document.getElementById('validation-warnings'),
            templateSearch: document.getElementById('template-search'),
            btnBackToWizard: document.getElementById('btn-back-to-wizard'),
            btnSaveAsTemplate: document.getElementById('btn-save-as-template'),
            btnClosePanel: document.getElementById('btn-close-panel'),
            btnApplyTemplate: document.getElementById('btn-apply-template'),
            btnCancel: document.getElementById('btn-cancel')
        };

        // Initialize navigation
        initNavigation('templates', () => {
            showSuccess('Templates are stored in browser');
        });

        // Initialize template manager
        showLoading('Loading templates...');
        await templateManager.initialize();
        hideLoading();

        let metadataLoadingShown = false;
        if (dbMetadata.tables.length === 0) {
            metadataLoadingShown = true;
            showLoading('Loading database metadata...');
        }

        await ensureTableList();

        if (metadataLoadingShown) {
            hideLoading();
        }

        // Render categories
        function renderCategories() {
            const categories = templateManager.getCategories();
            
            elements.categoryList.innerHTML = categories.map(cat => `
                <li class="category-item">
                    <button 
                        class="category-button ${cat.name === selectedCategory ? 'active' : ''}" 
                        data-category="${cat.name}"
                    >
                        <span>${cat.name}</span>
                        <span class="category-badge">${cat.count}</span>
                    </button>
                </li>
            `).join('');

            // Add event listeners
            elements.categoryList.querySelectorAll('.category-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedCategory = btn.getAttribute('data-category');
                    renderCategories();
                    renderTemplates();
                });
            });
        }

        // Render templates
        function renderTemplates() {
            let templates = templateManager.getTemplatesByCategory(selectedCategory);

            // Apply search filter
            if (searchTerm) {
                templates = templates.filter(t => 
                    t.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    t.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    t.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }

            if (templates.length === 0) {
                elements.templateGrid.style.display = 'none';
                elements.emptyState.style.display = 'block';
                return;
            }

            elements.templateGrid.style.display = 'grid';
            elements.emptyState.style.display = 'none';

            elements.templateGrid.innerHTML = templates.map(template => {
                const icons = {
                    'CRUD': 'üìù',
                    'BATCH': 'üì¶',
                    'TRANSFER': 'üîÑ',
                    'AUDIT': 'üìã',
                    'REPORTING': 'üìä',
                    'CUSTOM': '‚≠ê'
                };

                return `
                    <div class="template-card" data-template-id="${template.id}">
                        <div class="template-header">
                            <div class="template-icon">${icons[template.category] || 'üìÑ'}</div>
                            ${template.isBuiltIn 
                                ? '<span class="template-badge">Built-in</span>' 
                                : '<span class="template-badge custom">Custom</span>'}
                        </div>
                        <h3 class="template-title">${template.name}</h3>
                        <p class="template-description">${template.description}</p>
                        <div class="template-meta">
                            <span>üìä ${template.getSummary()}</span>
                        </div>
                        <div class="template-tags">
                            ${template.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <button class="btn btn-primary btn-sm" style="width: 100%;">
                            Use Template ‚Üí
                        </button>
                    </div>
                `;
            }).join('');

            // Add click handlers
            elements.templateGrid.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', async () => {
                    const templateId = card.getAttribute('data-template-id');

                    if (!tableMetadataAvailable) {
                        showLoading('Loading database metadata...');
                        await ensureTableList();
                        hideLoading();
                    } else if (dbMetadata.isStale()) {
                        await ensureTableList();
                    }

                    openCustomizationPanel(templateId);
                });
            });
        }

        // Open customization panel
        function openCustomizationPanel(templateId) {
            selectedTemplate = templateManager.getTemplateById(templateId);
            if (!selectedTemplate) return;

            elements.panelTitle.textContent = selectedTemplate.name;
            elements.panelSubtitle.textContent = selectedTemplate.description;

            // Build form
            elements.customizationForm.innerHTML = selectedTemplate.customizationPoints
                .map(renderCustomizationField)
                .join('');

            // Show panel
            elements.customizationPanel.classList.add('open');
            elements.panelOverlay.style.display = 'block';
        }

        // Close panel
        function closePanel() {
            elements.customizationPanel.classList.remove('open');
            elements.panelOverlay.style.display = 'none';
            elements.validationWarnings.style.display = 'none';
            selectedTemplate = null;
        }

        // Apply template
        function applyTemplate() {
            if (!selectedTemplate) return;

            // Gather form values
            const values = {};
            selectedTemplate.customizationPoints.forEach(point => {
                const field = document.getElementById(`field-${point.key}`);
                if (field) {
                    let value = field.value;
                    if (typeof value === 'string') {
                        value = value.trim();
                    }
                    values[point.key] = value;
                }
            });

            // Validate
            const validation = selectedTemplate.validateCustomizations(values);
            if (!validation.valid) {
                showError({
                    error_type: 'validation',
                    user_message: 'Please fill in all required fields',
                    technical_detail: validation.missing.join(', ')
                });
                return;
            }

            // Validate with metadata
            const metadataValidation = templateManager.validateWithMetadata(selectedTemplate, values);
            if (!metadataValidation.valid) {
                // Show warnings with suggestions
                elements.validationWarnings.style.display = 'block';
                elements.validationWarnings.innerHTML = `
                    <div class="validation-warning">
                        <h4>‚ö†Ô∏è Validation Warnings</h4>
                        <ul>
                            ${metadataValidation.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                        ${Object.keys(metadataValidation.suggestions).length > 0 ? `
                            <p><strong>Suggestions:</strong></p>
                            ${Object.entries(metadataValidation.suggestions).map(([key, suggestions]) => `
                                <p>${key}:</p>
                                <ul class="suggestions-list">
                                    ${suggestions.map(s => `<li onclick="document.getElementById('field-${key}').value='${s}'">${s}</li>`).join('')}
                                </ul>
                            `).join('')}
                        ` : ''}
                        <p style="margin-top: var(--spacing-md);">
                            <button class="btn btn-warning btn-sm" onclick="document.getElementById('btn-apply-template').click()">
                                Continue Anyway
                            </button>
                        </p>
                    </div>
                `;
                return;
            }

            // Apply template
            const procedure = templateManager.applyTemplate(selectedTemplate.id, values);
            if (procedure) {
                // Save to storage
                storageManager.saveState(procedure.toJSON());
                
                // Redirect to wizard
                window.location.href = 'wizard.html';
            }
        }

        // Event listeners
        elements.btnBackToWizard.addEventListener('click', () => {
            window.location.href = 'wizard.html';
        });

        elements.btnSaveAsTemplate.addEventListener('click', () => {
            // TODO: Implement save current procedure as template
            showError({
                error_type: 'info',
                user_message: 'Feature coming soon',
                technical_detail: 'Save as template will be implemented shortly'
            });
        });

        elements.templateSearch.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderTemplates();
        });

        elements.btnClosePanel.addEventListener('click', closePanel);
        elements.btnCancel.addEventListener('click', closePanel);
        elements.panelOverlay.addEventListener('click', closePanel);
        elements.btnApplyTemplate.addEventListener('click', applyTemplate);

        // Initial render
        renderCategories();
        renderTemplates();
    </script>
</body>
</html>