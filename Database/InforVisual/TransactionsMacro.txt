Dim htaPath, fso, htaFile

' Create the HTA file dynamically
Set fso = CreateObject("Scripting.FileSystemObject")
htaPath = fso.GetSpecialFolder(2) & "\PartLifecycle.hta"

Set htaFile = fso.CreateTextFile(htaPath, True)

' Write HTA content
htaFile.WriteLine "<html>"
htaFile.WriteLine "<head>"
htaFile.WriteLine "<title>Part Transaction Lifecycle Tracker</title>"
htaFile.WriteLine "<HTA:APPLICATION ID=""PartGrid"" APPLICATIONNAME=""Part Lifecycle Tracker"" SCROLL=""no"" SINGLEINSTANCE=""yes"" WINDOWSTATE=""normal"" />"
htaFile.WriteLine "<style>"
htaFile.WriteLine "* { box-sizing: border-box; }"
htaFile.WriteLine "html, body { margin:0; padding:0; height:100%; overflow-y:auto; overflow-x:hidden; background: #1e1e1e; color: #ffffff; }"
htaFile.WriteLine "body { font-family: 'Segoe UI', Arial; display: flex; flex-direction: column; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Header */"
htaFile.WriteLine "h2 { background: #2d2d30; color: #ffffff; padding: 12px; margin: 0; flex-shrink: 0; border-bottom: 1px solid #3f3f46; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Input Panel */"
htaFile.WriteLine ".input-panel { background: #252526; padding: 20px; border-bottom: 1px solid #3f3f46; flex-shrink: 0; box-shadow: inset 0 1px 0 rgba(255,255,255,0.1); }"
htaFile.WriteLine ".input-row { display: flex; align-items: center; margin-bottom: 12px; gap: 12px; }"
htaFile.WriteLine ".input-row.stretch { flex: 1; }"
htaFile.WriteLine ".input-row.buttons { justify-content: center; }"
htaFile.WriteLine ".input-row.status { justify-content: center; margin-bottom: 0; }"
htaFile.WriteLine ".input-panel input { padding: 10px 12px; font-size: 14px; flex: 1; background: #3c3c3c; color: #ffffff; border: 1px solid #464647; border-radius: 4px; height: 38px; line-height: 18px; min-width: 120px; }"
htaFile.WriteLine ".input-panel input:focus { border-color: #0078d4; outline: none; box-shadow: 0 0 0 1px #0078d4; }"
htaFile.WriteLine ".input-panel input[type='date'] { flex: 0 0 180px; }"
htaFile.WriteLine ".input-panel button { padding: 10px 20px; font-size: 14px; background: #0078d4; color: white; border: none; cursor: pointer; border-radius: 4px; height: 40px; transition: background-color 0.2s; white-space: nowrap; margin: 0 4px; }"
htaFile.WriteLine ".input-panel button:hover { background: #106ebe; }"
htaFile.WriteLine ".input-panel button.today-btn { background: #ca5010; }"
htaFile.WriteLine ".input-panel button.today-btn:hover { background: #b4460e; }"
htaFile.WriteLine ".input-panel label { font-weight: 600; color: #cccccc; white-space: nowrap; min-width: 60px; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Main Container */"
htaFile.WriteLine ".main-container { flex: 1; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; background: #1e1e1e; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Lifecycle Panel */"
htaFile.WriteLine ".lifecycle-panel { border: 1px solid #3f3f46; margin: 8px 12px; background: #252526; flex-shrink: 0; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }"
htaFile.WriteLine ".lifecycle-header { background: #0078d4; color: white; padding: 8px 12px; cursor: pointer; position: relative; font-weight: 600; border-radius: 6px 6px 0 0; transition: background-color 0.2s; font-size: 14px; }"
htaFile.WriteLine ".lifecycle-header:hover { background: #106ebe; }"
htaFile.WriteLine ".lifecycle-content { padding: 12px; max-height: 400px; overflow-y: auto; overflow-x: auto; display: none; background: #2d2d30; border-radius: 0 0 6px 6px; }"
htaFile.WriteLine ".lifecycle-content.show { display: block; }"
htaFile.WriteLine ".toggle-icon { float: right; font-size: 16px; transition: transform 0.3s; }"
htaFile.WriteLine ".toggle-icon.open { transform: rotate(180deg); }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Results Panel */"
htaFile.WriteLine ".results-panel { border: 1px solid #3f3f46; margin: 8px 12px; background: #252526; flex: 1; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); display: flex; flex-direction: column; }"
htaFile.WriteLine ".results-header { background: #ca5010; color: white; padding: 8px 12px; cursor: pointer; position: relative; font-weight: 600; border-radius: 6px 6px 0 0; transition: background-color 0.2s; font-size: 14px; }"
htaFile.WriteLine ".results-header:hover { background: #b4460e; }"
htaFile.WriteLine ".results-content { padding: 0; flex: 1; overflow-y: auto; overflow-x: auto; display: block; background: #2d2d30; border-radius: 0 0 6px 6px; }"
htaFile.WriteLine ".results-content.hide { display: none; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Table Container */"
htaFile.WriteLine ".table-container { width: 100%; overflow-x: auto; background: #2d2d30; padding: 16px; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Table Styles */"
htaFile.WriteLine "table { width: 100%; border: 1px solid #3f3f46; border-collapse: collapse; min-width: 800px; background: #2d2d30; border-radius: 6px; overflow: hidden; }"
htaFile.WriteLine "th { background: #0078d4; color: white; padding: 12px 8px; text-align: left; cursor: pointer; position: sticky; top: 0; user-select: none; white-space: nowrap; font-weight: 600; border-bottom: 1px solid #106ebe; }"
htaFile.WriteLine "th:hover { background: #106ebe; }"
htaFile.WriteLine "th.sorted-asc::after { content: ' ?'; position: absolute; right: 8px; }"
htaFile.WriteLine "th.sorted-desc::after { content: ' ?'; position: absolute; right: 8px; }"
htaFile.WriteLine "td { padding: 10px 8px; border: 1px solid #3f3f46; white-space: nowrap; color: #ffffff; }"
htaFile.WriteLine "tbody tr { cursor: pointer; transition: background-color 0.2s; }"
htaFile.WriteLine "tbody tr:hover { background: #383838 !important; }"
htaFile.WriteLine "tbody tr.selected { background: #264f78 !important; font-weight: bold; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Row Type Colors - Dark Mode */"
htaFile.WriteLine ".receipt { background: #1a4c2e; }"
htaFile.WriteLine ".transfer-out { background: #4c2c1a; }"
htaFile.WriteLine ".transfer-in { background: #1a2e4c; }"
htaFile.WriteLine ".shipment { background: #4c1a1a; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Lifecycle Table */"
htaFile.WriteLine ".lifecycle-table { width: 100%; max-width: 100%; border-collapse: collapse; background: #2d2d30; margin-top: 8px; font-size: 12px; border-radius: 4px; overflow: hidden; table-layout: fixed; }"
htaFile.WriteLine ".lifecycle-table th { background: #0078d4; color: white; padding: 6px 4px; border: 1px solid #106ebe; text-align: left; font-weight: 600; font-size: 11px; overflow: hidden; text-overflow: ellipsis; }"
htaFile.WriteLine ".lifecycle-table td { padding: 6px 4px; border: 1px solid #3f3f46; color: #ffffff; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }"
htaFile.WriteLine ".lifecycle-wo { background: #1a4c2e; }"
htaFile.WriteLine ".lifecycle-transfer { background: #4c3a1a; }"
htaFile.WriteLine ".lifecycle-ship { background: #4c1a1a; }"
htaFile.WriteLine ".lifecycle-current { background: #ffd700 !important; color: #000000 !important; font-weight: bold; }"
htaFile.WriteLine ".lifecycle-matched { background: #1a3f4c; }"
htaFile.WriteLine ""
htaFile.WriteLine ".no-data { color: #cccccc; font-style: italic; padding: 20px; text-align: center; }"
htaFile.WriteLine ".legend { font-size: 12px; margin-top: 12px; color: #cccccc; }"
htaFile.WriteLine ".legend span { padding: 4px 10px; margin-right: 12px; border-radius: 4px; color: #ffffff; font-weight: 500; }"
htaFile.WriteLine ""
htaFile.WriteLine "/* Status and content styling */"
htaFile.WriteLine "#status { color: #cccccc !important; }"
htaFile.WriteLine "#content { padding: 16px; color: #ffffff; }"
htaFile.WriteLine "h3 { color: #ffffff; margin: 0 0 16px 0; font-weight: 600; }"
htaFile.WriteLine "h4 { color: #ffffff; margin: 0 0 12px 0; font-weight: 600; }"
htaFile.WriteLine "</style>"
htaFile.WriteLine "</head>"
htaFile.WriteLine "<body>"
htaFile.WriteLine "<h2>Part Transaction Lifecycle Tracker</h2>"
htaFile.WriteLine "<div class=""input-panel"">"
htaFile.WriteLine "    <div class=""input-row"">"
htaFile.WriteLine "        <label>Part ID:</label>"
htaFile.WriteLine "        <input type=""text"" id=""partIDInput"" placeholder=""Enter Part ID..."" onkeypress=""vbscript:if window.event.keyCode=13 then LoadData"">"
htaFile.WriteLine "        <label>From:</label>"
htaFile.WriteLine "        <input type=""date"" id=""fromDate"">"
htaFile.WriteLine "        <label>To:</label>"
htaFile.WriteLine "        <input type=""date"" id=""toDate"">"
htaFile.WriteLine "    </div>"
htaFile.WriteLine "    <div class=""input-row buttons"">"
htaFile.WriteLine "        <button onclick=""LoadData"">Load Transactions</button>"
htaFile.WriteLine "        <button onclick=""LoadTodaysTransactions"" class=""today-btn"">Today's Transactions</button>"
htaFile.WriteLine "        <button onclick=""ExportData"">Export</button>"
htaFile.WriteLine "        <button onclick=""window.close"">Close</button>"
htaFile.WriteLine "    </div>"
htaFile.WriteLine "    <div class=""input-row status"">"
htaFile.WriteLine "        <span id=""status"" style=""color: #cccccc;""></span>"
htaFile.WriteLine "    </div>"
htaFile.WriteLine "</div>"
htaFile.WriteLine ""
htaFile.WriteLine "<div class=""main-container"">"
htaFile.WriteLine "    <!-- Lifecycle Panel -->"
htaFile.WriteLine "    <div id=""lifecyclePanel"" class=""lifecycle-panel"" style=""display:none;"">"
htaFile.WriteLine "        <div class=""lifecycle-header"" onclick=""ToggleLifecycle"">"
htaFile.WriteLine "            <span id=""lifecycleTitle"">Transaction Lifecycle</span>"
htaFile.WriteLine "            <span id=""toggleIcon"" class=""toggle-icon"">?</span>"
htaFile.WriteLine "        </div>"
htaFile.WriteLine "        <div id=""lifecycleContent"" class=""lifecycle-content"">"
htaFile.WriteLine "            <div class=""no-data"">Select a transaction below to view its lifecycle</div>"
htaFile.WriteLine "        </div>"
htaFile.WriteLine "    </div>"
htaFile.WriteLine "    "
htaFile.WriteLine "    <!-- Results Panel -->"
htaFile.WriteLine "    <div id=""resultsPanel"" class=""results-panel"">"
htaFile.WriteLine "        <div class=""results-header"" onclick=""ToggleResults"">"
htaFile.WriteLine "            <span id=""resultsTitle"">Transaction Results</span>"
htaFile.WriteLine "            <span id=""resultsToggleIcon"" class=""toggle-icon"">?</span>"
htaFile.WriteLine "        </div>"
htaFile.WriteLine "        <div id=""resultsContent"" class=""results-content"">"
htaFile.WriteLine "            <div id=""content"">Enter a Part ID and click 'Load Transactions' to begin...</div>"
htaFile.WriteLine "        </div>"
htaFile.WriteLine "    </div>"
htaFile.WriteLine "</div>"
htaFile.WriteLine ""
htaFile.WriteLine "<script language=""VBScript"">"
htaFile.WriteLine "Dim conn, allData, currentPartID, tableData, rowCount, selectedRow"
htaFile.WriteLine "Dim sortColumn, sortAscending, searchMode, currentUser, currentPassword"
htaFile.WriteLine "currentPartID = """""
htaFile.WriteLine "selectedRow = -1"
htaFile.WriteLine "sortColumn = -1"
htaFile.WriteLine "sortAscending = True"
htaFile.WriteLine "currentUser = """""
htaFile.WriteLine "currentPassword = """""
htaFile.WriteLine "rowCount = 0"
htaFile.WriteLine "searchMode = ""normal"" ' normal or today"
htaFile.WriteLine "ReDim tableData(1000, 11)"
htaFile.WriteLine ""
htaFile.WriteLine "Sub Window_OnLoad"
htaFile.WriteLine "    ' Prompt for user credentials"
htaFile.WriteLine "    currentUser = InputBox(""Enter your username:"", ""Login Required"", """")"
htaFile.WriteLine "    If currentUser = """" Then"
htaFile.WriteLine "        MsgBox ""Username is required. Application will close."", vbExclamation"
htaFile.WriteLine "        window.close"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    currentPassword = InputBox(""Enter your password:"", ""Login Required"", """")"
htaFile.WriteLine "    If currentPassword = """" Then"
htaFile.WriteLine "        MsgBox ""Password is required. Application will close."", vbExclamation"
htaFile.WriteLine "        window.close"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    window.resizeTo 1050, 675"
htaFile.WriteLine "    Dim sw, sh"
htaFile.WriteLine "    sw = window.screen.availWidth"
htaFile.WriteLine "    sh = window.screen.availHeight"
htaFile.WriteLine "    window.moveTo (sw - 1050) / 2, (sh - 675) / 2"
htaFile.WriteLine "    document.getElementById(""partIDInput"").focus"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Set default date range (last 30 days to today)"
htaFile.WriteLine "    Dim today, fromDay"
htaFile.WriteLine "    today = Date"
htaFile.WriteLine "    fromDay = DateAdd(""d"", -30, today)"
htaFile.WriteLine "    document.getElementById(""toDate"").value = FormatDateTime(today, 2)"
htaFile.WriteLine "    document.getElementById(""fromDate"").value = FormatDateTime(fromDay, 2)"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub ToggleLifecycle"
htaFile.WriteLine "    Dim content, icon"
htaFile.WriteLine "    Set content = document.getElementById(""lifecycleContent"")"
htaFile.WriteLine "    Set icon = document.getElementById(""toggleIcon"")"
htaFile.WriteLine "    "
htaFile.WriteLine "    If content.className = ""lifecycle-content"" Then"
htaFile.WriteLine "        content.className = ""lifecycle-content show"""
htaFile.WriteLine "        icon.innerHTML = ""?"""
htaFile.WriteLine "    Else"
htaFile.WriteLine "        content.className = ""lifecycle-content"""
htaFile.WriteLine "        icon.innerHTML = ""?"""
htaFile.WriteLine "    End If"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub ToggleResults"
htaFile.WriteLine "    Dim content, icon"
htaFile.WriteLine "    Set content = document.getElementById(""resultsContent"")"
htaFile.WriteLine "    Set icon = document.getElementById(""resultsToggleIcon"")"
htaFile.WriteLine "    "
htaFile.WriteLine "    If content.className = ""results-content hide"" Then"
htaFile.WriteLine "        content.className = ""results-content"""
htaFile.WriteLine "        icon.innerHTML = ""?"""
htaFile.WriteLine "    Else"
htaFile.WriteLine "        content.className = ""results-content hide"""
htaFile.WriteLine "        icon.innerHTML = ""?"""
htaFile.WriteLine "    End If"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub ShowLifecyclePanel"
htaFile.WriteLine "    document.getElementById(""lifecyclePanel"").style.display = ""block"""
htaFile.WriteLine "    document.getElementById(""lifecycleContent"").className = ""lifecycle-content show"""
htaFile.WriteLine "    document.getElementById(""toggleIcon"").innerHTML = ""?"""
htaFile.WriteLine "    document.getElementsByClassName(""main-container"")(0).scrollTop = 0"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub LoadData"
htaFile.WriteLine "    On Error Resume Next"
htaFile.WriteLine "    Dim partID, rs, sql, fromDate, toDate"
htaFile.WriteLine "    "
htaFile.WriteLine "    partID = Trim(document.getElementById(""partIDInput"").value)"
htaFile.WriteLine "    If partID = """" Then"
htaFile.WriteLine "        MsgBox ""Please enter a Part ID"", vbExclamation"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    fromDate = document.getElementById(""fromDate"").value"
htaFile.WriteLine "    toDate = document.getElementById(""toDate"").value"
htaFile.WriteLine "    "
htaFile.WriteLine "    currentPartID = partID"
htaFile.WriteLine "    selectedRow = -1"
htaFile.WriteLine "    searchMode = ""normal"""
htaFile.WriteLine "    document.getElementById(""status"").innerText = ""Loading..."""
htaFile.WriteLine "    document.getElementById(""lifecyclePanel"").style.display = ""none"""
htaFile.WriteLine "    "
htaFile.WriteLine "    Set conn = CreateObject(""ADODB.Connection"")"
htaFile.WriteLine "    conn.ConnectionString = ""Provider=SQLOLEDB;Data Source=VISUAL;Initial Catalog=MTMFG;User ID="" & currentUser & "";Password="" & currentPassword & "";"""
htaFile.WriteLine "    conn.Open"
htaFile.WriteLine "    "
htaFile.WriteLine "    If Err.Number <> 0 Then"
htaFile.WriteLine "        document.getElementById(""status"").innerText = ""Connection failed: "" & Err.Description"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    sql = ""SELECT TOP 1000 TRANSACTION_ID, TRANSACTION_DATE, CREATE_DATE, TYPE, QTY, "" & _"
htaFile.WriteLine "          ""WAREHOUSE_ID, LOCATION_ID, USER_ID, DESCRIPTION, "" & _"
htaFile.WriteLine "          ""WORKORDER_BASE_ID, WORKORDER_LOT_ID, CUST_ORDER_ID, PURC_ORDER_ID "" & _"
htaFile.WriteLine "          ""FROM INVENTORY_TRANS WHERE PART_ID = '"" & partID & ""'"""
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Add date filtering if dates are provided"
htaFile.WriteLine "    If fromDate <> """" And toDate <> """" Then"
htaFile.WriteLine "        sql = sql & "" AND CAST(COALESCE(CREATE_DATE, TRANSACTION_DATE) AS DATE) BETWEEN '"" & fromDate & ""' AND '"" & toDate & ""'"""
htaFile.WriteLine "    ElseIf fromDate <> """" Then"
htaFile.WriteLine "        sql = sql & "" AND CAST(COALESCE(CREATE_DATE, TRANSACTION_DATE) AS DATE) >= '"" & fromDate & ""'"""
htaFile.WriteLine "    ElseIf toDate <> """" Then"
htaFile.WriteLine "        sql = sql & "" AND CAST(COALESCE(CREATE_DATE, TRANSACTION_DATE) AS DATE) <= '"" & toDate & ""'"""
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    sql = sql & "" ORDER BY CREATE_DATE DESC, TRANSACTION_ID DESC"""
htaFile.WriteLine "    "
htaFile.WriteLine "    Set rs = conn.Execute(sql)"
htaFile.WriteLine "    "
htaFile.WriteLine "    If Err.Number <> 0 Then"
htaFile.WriteLine "        document.getElementById(""status"").innerText = ""SQL Error: "" & Err.Description"
htaFile.WriteLine "        conn.Close"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    rowCount = 0"
htaFile.WriteLine "    "
htaFile.WriteLine "    If Not rs.EOF Then"
htaFile.WriteLine "        Do While Not rs.EOF And rowCount < 1000"
htaFile.WriteLine "            tableData(rowCount, 0) = rs(""TRANSACTION_ID"")"
htaFile.WriteLine "            "
htaFile.WriteLine "            If Not IsNull(rs(""CREATE_DATE"")) Then"
htaFile.WriteLine "                tableData(rowCount, 1) = FormatDateTime(rs(""CREATE_DATE""), 2)"
htaFile.WriteLine "                tableData(rowCount, 2) = FormatDateTime(rs(""CREATE_DATE""), 4)"
htaFile.WriteLine "                tableData(rowCount, 10) = rs(""CREATE_DATE"")"
htaFile.WriteLine "            Else"
htaFile.WriteLine "                tableData(rowCount, 1) = FormatDateTime(rs(""TRANSACTION_DATE""), 2)"
htaFile.WriteLine "                tableData(rowCount, 2) = ""00:00"""
htaFile.WriteLine "                tableData(rowCount, 10) = rs(""TRANSACTION_DATE"")"
htaFile.WriteLine "            End If"
htaFile.WriteLine "            "
htaFile.WriteLine "            tableData(rowCount, 3) = rs(""TYPE"")"
htaFile.WriteLine "            tableData(rowCount, 4) = rs(""QTY"")"
htaFile.WriteLine "            tableData(rowCount, 5) = rs(""WAREHOUSE_ID"")"
htaFile.WriteLine "            tableData(rowCount, 6) = rs(""LOCATION_ID"") & """""
htaFile.WriteLine "            "
htaFile.WriteLine "            Dim ref"
htaFile.WriteLine "            ref = """""
htaFile.WriteLine "            If Not IsNull(rs(""WORKORDER_BASE_ID"")) Then "
htaFile.WriteLine "                ref = ""WO: "" & rs(""WORKORDER_BASE_ID"")"
htaFile.WriteLine "            ElseIf Not IsNull(rs(""CUST_ORDER_ID"")) Then "
htaFile.WriteLine "                ref = ""CO: "" & rs(""CUST_ORDER_ID"")"
htaFile.WriteLine "            ElseIf Not IsNull(rs(""PURC_ORDER_ID"")) Then "
htaFile.WriteLine "                ref = ""PO: "" & rs(""PURC_ORDER_ID"")"
htaFile.WriteLine "            End If"
htaFile.WriteLine "            tableData(rowCount, 7) = ref"
htaFile.WriteLine "            "
htaFile.WriteLine "            tableData(rowCount, 8) = rs(""USER_ID"")"
htaFile.WriteLine "            "
htaFile.WriteLine "            If Not IsNull(rs(""WORKORDER_BASE_ID"")) Then"
htaFile.WriteLine "                tableData(rowCount, 9) = rs(""WORKORDER_BASE_ID"")"
htaFile.WriteLine "            Else"
htaFile.WriteLine "                tableData(rowCount, 9) = """""
htaFile.WriteLine "            End If"
htaFile.WriteLine "            "
htaFile.WriteLine "            If rs(""TYPE"") = ""I"" And Not IsNull(rs(""WORKORDER_BASE_ID"")) Then"
htaFile.WriteLine "                tableData(rowCount, 11) = ""receipt"""
htaFile.WriteLine "            ElseIf rs(""TYPE"") = ""I"" Then"
htaFile.WriteLine "                tableData(rowCount, 11) = ""transfer-in"""
htaFile.WriteLine "            ElseIf rs(""TYPE"") = ""O"" And Not IsNull(rs(""CUST_ORDER_ID"")) Then"
htaFile.WriteLine "                tableData(rowCount, 11) = ""shipment"""
htaFile.WriteLine "            ElseIf rs(""TYPE"") = ""O"" Then"
htaFile.WriteLine "                tableData(rowCount, 11) = ""transfer-out"""
htaFile.WriteLine "            Else"
htaFile.WriteLine "                tableData(rowCount, 11) = """""
htaFile.WriteLine "            End If"
htaFile.WriteLine "            "
htaFile.WriteLine "            rowCount = rowCount + 1"
htaFile.WriteLine "            rs.MoveNext"
htaFile.WriteLine "        Loop"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    rs.Close"
htaFile.WriteLine "    conn.Close"
htaFile.WriteLine "    "
htaFile.WriteLine "    DisplayTable"
htaFile.WriteLine "    document.getElementById(""status"").innerText = ""Loaded "" & rowCount & "" transactions"""
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub LoadTodaysTransactions"
htaFile.WriteLine "    On Error Resume Next"
htaFile.WriteLine "    Dim rs, sql"
htaFile.WriteLine "    "
htaFile.WriteLine "    currentPartID = ""Today's Transactions"""
htaFile.WriteLine "    selectedRow = -1"
htaFile.WriteLine "    searchMode = ""today"""
htaFile.WriteLine "    document.getElementById(""status"").innerText = ""Loading today's transactions..."""
htaFile.WriteLine "    document.getElementById(""lifecyclePanel"").style.display = ""none"""
htaFile.WriteLine "    "
htaFile.WriteLine "    Set conn = CreateObject(""ADODB.Connection"")"
htaFile.WriteLine "    conn.ConnectionString = ""Provider=SQLOLEDB;Data Source=VISUAL;Initial Catalog=MTMFG;User ID="" & currentUser & "";Password="" & currentPassword & "";"""
htaFile.WriteLine "    conn.Open"
htaFile.WriteLine "    "
htaFile.WriteLine "    If Err.Number <> 0 Then"
htaFile.WriteLine "        document.getElementById(""status"").innerText = ""Connection failed: "" & Err.Description"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    sql = ""SELECT TOP 200 TRANSACTION_ID, TRANSACTION_DATE, CREATE_DATE, TYPE, QTY, "" & _"
htaFile.WriteLine "          ""WAREHOUSE_ID, LOCATION_ID, USER_ID, DESCRIPTION, PART_ID, "" & _"
htaFile.WriteLine "          ""WORKORDER_BASE_ID, WORKORDER_LOT_ID, CUST_ORDER_ID, PURC_ORDER_ID "" & _"
htaFile.WriteLine "          ""FROM INVENTORY_TRANS WHERE CAST(COALESCE(CREATE_DATE, TRANSACTION_DATE) AS DATE) = CAST(GETDATE() AS DATE) "" & _"
htaFile.WriteLine "          ""AND USER_ID = '"" & currentUser & ""' "" & _"
htaFile.WriteLine "          ""ORDER BY CREATE_DATE DESC, TRANSACTION_ID DESC"""
htaFile.WriteLine "    "
htaFile.WriteLine "    Set rs = conn.Execute(sql)"
htaFile.WriteLine "    "
htaFile.WriteLine "    If Err.Number <> 0 Then"
htaFile.WriteLine "        document.getElementById(""status"").innerText = ""SQL Error: "" & Err.Description"
htaFile.WriteLine "        conn.Close"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Load raw data first"
htaFile.WriteLine "    Dim rawData(), rawCount"
htaFile.WriteLine "    rawCount = 0"
htaFile.WriteLine "    ReDim rawData(200, 11)"
htaFile.WriteLine "    "
htaFile.WriteLine "    If Not rs.EOF Then"
htaFile.WriteLine "        Do While Not rs.EOF And rawCount < 200"
htaFile.WriteLine "            rawData(rawCount, 0) = rs(""TRANSACTION_ID"")"
htaFile.WriteLine "            rawData(rawCount, 3) = rs(""TYPE"")"
htaFile.WriteLine "            rawData(rawCount, 4) = rs(""QTY"")"
htaFile.WriteLine "            rawData(rawCount, 5) = rs(""WAREHOUSE_ID"")"
htaFile.WriteLine "            rawData(rawCount, 8) = rs(""USER_ID"")"
htaFile.WriteLine "            rawData(rawCount, 9) = rs(""PART_ID"")"
htaFile.WriteLine "            rawData(rawCount, 11) = rs(""LOCATION_ID"")"
htaFile.WriteLine "            "
htaFile.WriteLine "            If Not IsNull(rs(""CREATE_DATE"")) Then"
htaFile.WriteLine "                rawData(rawCount, 1) = FormatDateTime(rs(""CREATE_DATE""), 2)"
htaFile.WriteLine "                rawData(rawCount, 2) = FormatDateTime(rs(""CREATE_DATE""), 4)"
htaFile.WriteLine "                rawData(rawCount, 10) = rs(""CREATE_DATE"")"
htaFile.WriteLine "            Else"
htaFile.WriteLine "                rawData(rawCount, 1) = FormatDateTime(rs(""TRANSACTION_DATE""), 2)"
htaFile.WriteLine "                rawData(rawCount, 2) = ""00:00"""
htaFile.WriteLine "                rawData(rawCount, 10) = rs(""TRANSACTION_DATE"")"
htaFile.WriteLine "            End If"
htaFile.WriteLine "            "
htaFile.WriteLine "            Dim ref"
htaFile.WriteLine "            ref = """""
htaFile.WriteLine "            If Not IsNull(rs(""WORKORDER_BASE_ID"")) Then "
htaFile.WriteLine "                ref = ""WO: "" & rs(""WORKORDER_BASE_ID"")"
htaFile.WriteLine "            ElseIf Not IsNull(rs(""CUST_ORDER_ID"")) Then "
htaFile.WriteLine "                ref = ""CO: "" & rs(""CUST_ORDER_ID"")"
htaFile.WriteLine "            ElseIf Not IsNull(rs(""PURC_ORDER_ID"")) Then "
htaFile.WriteLine "                ref = ""PO: "" & rs(""PURC_ORDER_ID"")"
htaFile.WriteLine "            End If"
htaFile.WriteLine "            rawData(rawCount, 7) = ref"
htaFile.WriteLine "            "
htaFile.WriteLine "            rawCount = rawCount + 1"
htaFile.WriteLine "            rs.MoveNext"
htaFile.WriteLine "        Loop"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    rs.Close"
htaFile.WriteLine "    conn.Close"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Now process into combined transfers"
htaFile.WriteLine "    ProcessTodaysTransfers rawData, rawCount"
htaFile.WriteLine "    DisplayTodaysTable"
htaFile.WriteLine "    document.getElementById(""status"").innerText = ""Loaded "" & rowCount & "" transaction groups for today"""
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub ProcessTodaysTransfers(rawData, rawCount)"
htaFile.WriteLine "    On Error Resume Next"
htaFile.WriteLine "    rowCount = 0"
htaFile.WriteLine "    If rawCount = 0 Then Exit Sub"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Sort raw data by time ascending"
htaFile.WriteLine "    Dim i, j, k, tmp"
htaFile.WriteLine "    For i = 0 To rawCount - 2"
htaFile.WriteLine "        For j = 0 To rawCount - i - 2"
htaFile.WriteLine "            If CDate(rawData(j, 10)) > CDate(rawData(j+1, 10)) Then"
htaFile.WriteLine "                For k = 0 To 11"
htaFile.WriteLine "                    tmp = rawData(j, k)"
htaFile.WriteLine "                    rawData(j, k) = rawData(j+1, k)"
htaFile.WriteLine "                    rawData(j+1, k) = tmp"
htaFile.WriteLine "                Next"
htaFile.WriteLine "            End If"
htaFile.WriteLine "        Next"
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    Dim used() : ReDim used(rawCount - 1)"
htaFile.WriteLine "    For i = 0 To rawCount - 1: used(i) = 0: Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' First pass: Work Orders (receipts)"
htaFile.WriteLine "    For i = 0 To rawCount - 1"
htaFile.WriteLine "        If used(i) = 0 And rawData(i, 3) = ""I"" And InStr(rawData(i, 7), ""WO:"") > 0 Then"
htaFile.WriteLine "            tableData(rowCount, 0) = rawData(i, 0) ' Trans ID"
htaFile.WriteLine "            tableData(rowCount, 1) = rawData(i, 1) ' Date"
htaFile.WriteLine "            tableData(rowCount, 2) = rawData(i, 2) ' Time"
htaFile.WriteLine "            tableData(rowCount, 3) = ""RECEIPT"""
htaFile.WriteLine "            tableData(rowCount, 4) = rawData(i, 4) ' Qty"
htaFile.WriteLine "            tableData(rowCount, 5) = rawData(i, 5) ' Warehouse"
htaFile.WriteLine "            tableData(rowCount, 6) = rawData(i, 9) & "" -> "" & rawData(i, 11) ' Part -> Location"
htaFile.WriteLine "            tableData(rowCount, 7) = rawData(i, 7) ' Reference"
htaFile.WriteLine "            tableData(rowCount, 8) = rawData(i, 8) ' User"
htaFile.WriteLine "            tableData(rowCount, 9) = rawData(i, 9) ' Part ID"
htaFile.WriteLine "            tableData(rowCount, 10) = rawData(i, 10) ' Date obj"
htaFile.WriteLine "            tableData(rowCount, 11) = ""receipt"""
htaFile.WriteLine "            used(i) = 1"
htaFile.WriteLine "            rowCount = rowCount + 1"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Second pass: Combine transfers (OUT + IN pairs)"
htaFile.WriteLine "    For i = 0 To rawCount - 1"
htaFile.WriteLine "        If used(i) = 0 And rawData(i, 3) = ""O"" And InStr(rawData(i, 7), ""CO:"") = 0 Then"
htaFile.WriteLine "            Dim bestMatch, minTimeDiff, timeDiff"
htaFile.WriteLine "            bestMatch = -1"
htaFile.WriteLine "            minTimeDiff = 999999"
htaFile.WriteLine "            "
htaFile.WriteLine "            ' Look for matching IN within next few transactions"
htaFile.WriteLine "            For j = i + 1 To rawCount - 1"
htaFile.WriteLine "                If used(j) = 0 And rawData(j, 3) = ""I"" Then"
htaFile.WriteLine "                    If InStr(rawData(j, 7), ""WO:"") = 0 And InStr(rawData(j, 7), ""PO:"") = 0 Then"
htaFile.WriteLine "                        If Abs(CDbl(rawData(i, 4))) = Abs(CDbl(rawData(j, 4))) And rawData(i, 9) = rawData(j, 9) Then"
htaFile.WriteLine "                            timeDiff = DateDiff(""s"", rawData(i, 10), rawData(j, 10))"
htaFile.WriteLine "                            If timeDiff >= 0 And timeDiff < 300 Then ' Within 5 minutes"
htaFile.WriteLine "                                If timeDiff < minTimeDiff Then"
htaFile.WriteLine "                                    minTimeDiff = timeDiff"
htaFile.WriteLine "                                    bestMatch = j"
htaFile.WriteLine "                                End If"
htaFile.WriteLine "                            End If"
htaFile.WriteLine "                        End If"
htaFile.WriteLine "                    End If"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            Next"
htaFile.WriteLine "            "
htaFile.WriteLine "            If bestMatch <> -1 Then"
htaFile.WriteLine "                ' Combined transfer entry"
htaFile.WriteLine "                tableData(rowCount, 0) = rawData(i, 0) & ""/"" & rawData(bestMatch, 0)"
htaFile.WriteLine "                tableData(rowCount, 1) = rawData(i, 1)"
htaFile.WriteLine "                tableData(rowCount, 2) = rawData(i, 2)"
htaFile.WriteLine "                tableData(rowCount, 3) = ""TRANSFER"""
htaFile.WriteLine "                tableData(rowCount, 4) = rawData(i, 4)"
htaFile.WriteLine "                tableData(rowCount, 5) = rawData(i, 5)"
htaFile.WriteLine "                tableData(rowCount, 6) = rawData(i, 9) & "": "" & rawData(i, 11) & "" -> "" & rawData(bestMatch, 11)"
htaFile.WriteLine "                tableData(rowCount, 7) = ""Transfer"""
htaFile.WriteLine "                tableData(rowCount, 8) = rawData(i, 8)"
htaFile.WriteLine "                tableData(rowCount, 9) = rawData(i, 9)"
htaFile.WriteLine "                tableData(rowCount, 10) = rawData(i, 10)"
htaFile.WriteLine "                tableData(rowCount, 11) = ""transfer-out"""
htaFile.WriteLine "                used(i) = 1"
htaFile.WriteLine "                used(bestMatch) = 1"
htaFile.WriteLine "                rowCount = rowCount + 1"
htaFile.WriteLine "            End If"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Third pass: Shipments"
htaFile.WriteLine "    For i = 0 To rawCount - 1"
htaFile.WriteLine "        If used(i) = 0 And rawData(i, 3) = ""O"" And InStr(rawData(i, 7), ""CO:"") > 0 Then"
htaFile.WriteLine "            tableData(rowCount, 0) = rawData(i, 0)"
htaFile.WriteLine "            tableData(rowCount, 1) = rawData(i, 1)"
htaFile.WriteLine "            tableData(rowCount, 2) = rawData(i, 2)"
htaFile.WriteLine "            tableData(rowCount, 3) = ""SHIPMENT"""
htaFile.WriteLine "            tableData(rowCount, 4) = rawData(i, 4)"
htaFile.WriteLine "            tableData(rowCount, 5) = rawData(i, 5)"
htaFile.WriteLine "            tableData(rowCount, 6) = rawData(i, 9) & "": "" & rawData(i, 11) & "" -> Customer"""
htaFile.WriteLine "            tableData(rowCount, 7) = rawData(i, 7)"
htaFile.WriteLine "            tableData(rowCount, 8) = rawData(i, 8)"
htaFile.WriteLine "            tableData(rowCount, 9) = rawData(i, 9)"
htaFile.WriteLine "            tableData(rowCount, 10) = rawData(i, 10)"
htaFile.WriteLine "            tableData(rowCount, 11) = ""shipment"""
htaFile.WriteLine "            used(i) = 1"
htaFile.WriteLine "            rowCount = rowCount + 1"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Fourth pass: Unmatched transactions"
htaFile.WriteLine "    For i = 0 To rawCount - 1"
htaFile.WriteLine "        If used(i) = 0 Then"
htaFile.WriteLine "            tableData(rowCount, 0) = rawData(i, 0)"
htaFile.WriteLine "            tableData(rowCount, 1) = rawData(i, 1)"
htaFile.WriteLine "            tableData(rowCount, 2) = rawData(i, 2)"
htaFile.WriteLine "            tableData(rowCount, 3) = rawData(i, 3) & "" (Solo)"""
htaFile.WriteLine "            tableData(rowCount, 4) = rawData(i, 4)"
htaFile.WriteLine "            tableData(rowCount, 5) = rawData(i, 5)"
htaFile.WriteLine "            tableData(rowCount, 6) = rawData(i, 9) & "" @ "" & rawData(i, 11)"
htaFile.WriteLine "            tableData(rowCount, 7) = rawData(i, 7)"
htaFile.WriteLine "            tableData(rowCount, 8) = rawData(i, 8)"
htaFile.WriteLine "            tableData(rowCount, 9) = rawData(i, 9)"
htaFile.WriteLine "            tableData(rowCount, 10) = rawData(i, 10)"
htaFile.WriteLine "            If rawData(i, 3) = ""I"" Then"
htaFile.WriteLine "                tableData(rowCount, 11) = ""transfer-in"""
htaFile.WriteLine "            Else"
htaFile.WriteLine "                tableData(rowCount, 11) = ""transfer-out"""
htaFile.WriteLine "            End If"
htaFile.WriteLine "            rowCount = rowCount + 1"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub DisplayTodaysTable"
htaFile.WriteLine "    Dim tableHTML, i"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Update the results panel title"
htaFile.WriteLine "    document.getElementById(""resultsTitle"").innerHTML = ""Today's Combined Transactions for "" & currentUser & "" ("" & Date & "") ("" & rowCount & "" groups)"""
htaFile.WriteLine "    "
htaFile.WriteLine "    tableHTML = ""<div class='table-container'>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<table id='dataTable'><thead><tr>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(0)'>Trans ID(s)</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(1)'>Date</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(2)'>Time</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(3)'>Action</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(4)'>Qty</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(5)'>Warehouse</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(6)'>Flow</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(7)'>Reference</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(8)'>User</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""</tr></thead><tbody>"""
htaFile.WriteLine "    "
htaFile.WriteLine "    For i = 0 To rowCount - 1"
htaFile.WriteLine "        Dim rowClass"
htaFile.WriteLine "        rowClass = tableData(i, 11)"
htaFile.WriteLine "        If i = selectedRow Then rowClass = rowClass & "" selected"""
htaFile.WriteLine "        "
htaFile.WriteLine "        tableHTML = tableHTML & ""<tr id='row"" & i & ""' class='"" & rowClass & ""'>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 0) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 1) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 2) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td><b>"" & tableData(i, 3) & ""</b></td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td align='right'>"" & FormatNumber(tableData(i, 4), 2) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 5) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 6) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 7) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 8) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""</tr>"""
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    tableHTML = tableHTML & ""</tbody></table>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""</div>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<div class='legend'>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#1a4c2e;'>Receipt (WO)</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#4c3a1a;'>Transfer (Combined)</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#4c1a1a;'>Shipment</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#1a2e4c;'>Solo IN</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#4c2c1a;'>Solo OUT</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""</div>"""
htaFile.WriteLine "    "
htaFile.WriteLine "    document.getElementById(""content"").innerHTML = tableHTML"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub DisplayTable"
htaFile.WriteLine "    Dim tableHTML, i, headerText"
htaFile.WriteLine "    "
htaFile.WriteLine "    If searchMode = ""today"" Then"
htaFile.WriteLine "        headerText = ""Today's Transactions for "" & currentUser & "" ("" & Date & "")"""
htaFile.WriteLine "    Else"
htaFile.WriteLine "        headerText = ""Part: "" & currentPartID"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    ' Update the results panel title"
htaFile.WriteLine "    document.getElementById(""resultsTitle"").innerHTML = headerText & "" ("" & rowCount & "" records)"""
htaFile.WriteLine "    "
htaFile.WriteLine "    tableHTML = ""<div class='table-container'>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<table id='dataTable'><thead><tr>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(0)'>Trans ID</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(1)'>Date</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(2)'>Time</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(3)'>Type</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(4)'>Qty</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(5)'>Warehouse</th>"""
htaFile.WriteLine "    If searchMode = ""today"" Then"
htaFile.WriteLine "        tableHTML = tableHTML & ""<th onclick='SortTable(6)'>Part @ Location</th>"""
htaFile.WriteLine "    Else"
htaFile.WriteLine "        tableHTML = tableHTML & ""<th onclick='SortTable(6)'>Location</th>"""
htaFile.WriteLine "    End If"
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(7)'>Reference</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<th onclick='SortTable(8)'>User</th>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""</tr></thead><tbody>"""
htaFile.WriteLine "    "
htaFile.WriteLine "    For i = 0 To rowCount - 1"
htaFile.WriteLine "        Dim rowClass"
htaFile.WriteLine "        rowClass = tableData(i, 11)"
htaFile.WriteLine "        If i = selectedRow Then rowClass = rowClass & "" selected"""
htaFile.WriteLine "        "
htaFile.WriteLine "        tableHTML = tableHTML & ""<tr id='row"" & i & ""' class='"" & rowClass & ""' onclick='SelectRow "" & i & ""'>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 0) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 1) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 2) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 3) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td align='right'>"" & FormatNumber(tableData(i, 4), 2) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 5) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 6) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 7) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""<td>"" & tableData(i, 8) & ""</td>"""
htaFile.WriteLine "        tableHTML = tableHTML & ""</tr>"""
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    tableHTML = tableHTML & ""</tbody></table>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""</div>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<div class='legend'>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#1a4c2e;'>Receipt (WO)</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#1a2e4c;'>Transfer IN</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#4c2c1a;'>Transfer OUT</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""<span style='background:#4c1a1a;'>Shipment</span>"""
htaFile.WriteLine "    tableHTML = tableHTML & ""</div>"""
htaFile.WriteLine "    "
htaFile.WriteLine "    document.getElementById(""content"").innerHTML = tableHTML"
htaFile.WriteLine "    "
htaFile.WriteLine "    If sortColumn >= 0 Then"
htaFile.WriteLine "        Dim headers"
htaFile.WriteLine "        Set headers = document.getElementById(""dataTable"").getElementsByTagName(""th"")"
htaFile.WriteLine "        If sortAscending Then"
htaFile.WriteLine "            headers(sortColumn).className = ""sorted-asc"""
htaFile.WriteLine "        Else"
htaFile.WriteLine "            headers(sortColumn).className = ""sorted-desc"""
htaFile.WriteLine "        End If"
htaFile.WriteLine "    End If"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub SelectRow(rowIndex)"
htaFile.WriteLine "    If searchMode = ""today"" Then"
htaFile.WriteLine "        ' No lifecycle view for today's transactions"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    If selectedRow = rowIndex Then"
htaFile.WriteLine "        ' Clicking same row again - hide lifecycle"
htaFile.WriteLine "        selectedRow = -1"
htaFile.WriteLine "        document.getElementById(""lifecyclePanel"").style.display = ""none"""
htaFile.WriteLine "    Else"
htaFile.WriteLine "        selectedRow = rowIndex"
htaFile.WriteLine "        ShowLifecycle rowIndex"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    DisplayTable"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
' ===== FULL PART LIFECYCLE (replace old lifecycle code) =====



' ================== LIFECYCLE TEMPLATE (WO Receipt -> Transfers -> Shipment) ==================
htaFile.WriteLine "Sub ShowLifecycle(rowIndex)"
htaFile.WriteLine "    On Error Resume Next"
htaFile.WriteLine "    Dim transID"
htaFile.WriteLine "    transID = tableData(rowIndex, 0)"
htaFile.WriteLine "    document.getElementById(""lifecycleTitle"").innerHTML = ""Transaction Lifecycle (Template) - Trans ID: "" & transID"
htaFile.WriteLine "    document.getElementById(""lifecycleContent"").innerHTML = ""<p>Building lifecycle template...</p>"""
htaFile.WriteLine "    ShowLifecyclePanel"
htaFile.WriteLine "    BuildLifecycleTemplate rowIndex, transID"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub BuildLifecycleTemplate(selectedIndex, selectedTransID)"
htaFile.WriteLine "    On Error Resume Next"
htaFile.WriteLine "    If rowCount = 0 Then"
htaFile.WriteLine "        document.getElementById(""lifecycleContent"").innerHTML = ""<div class='no-data'>No transactions loaded.</div>"""
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine ""
htaFile.WriteLine "    Dim i, j"
htaFile.WriteLine "    ' Working copy of all loaded transactions. NOTE: Previous implementation filtered by column 9 (Work Order ID) assuming it was Part ID.'"
htaFile.WriteLine "    ' All rows already belong to the same Part (currentPartID) in normal search mode, so we copy everything.'"
htaFile.WriteLine "    Dim work(), wCount"
htaFile.WriteLine "    wCount = rowCount"
htaFile.WriteLine "    ReDim work(wCount - 1, 12)"
htaFile.WriteLine "    For i = 0 To wCount - 1"
htaFile.WriteLine "        For j = 0 To 11"
htaFile.WriteLine "            work(i, j) = tableData(i, j)"
htaFile.WriteLine "        Next"
htaFile.WriteLine "    Next"
htaFile.WriteLine ""
htaFile.WriteLine "    Dim a, b, tmp"
htaFile.WriteLine "    For a = 0 To wCount - 2"
htaFile.WriteLine "        For b = 0 To wCount - a - 2"
htaFile.WriteLine "            Dim rawA, rawB, keyA, keyB"
htaFile.WriteLine "            rawA = work(b,0): rawB = work(b+1,0)"
htaFile.WriteLine "            If InStr(rawA, ""/"") > 0 Then keyA = Split(rawA, ""/"")(0) Else keyA = rawA"
htaFile.WriteLine "            If InStr(rawB, ""/"") > 0 Then keyB = Split(rawB, ""/"")(0) Else keyB = rawB"
htaFile.WriteLine "            If Not IsNumeric(keyA) Then keyA = 0"
htaFile.WriteLine "            If Not IsNumeric(keyB) Then keyB = 0"
htaFile.WriteLine "            If IsDate(work(b,10)) And IsDate(work(b+1,10)) Then"
htaFile.WriteLine "                If CDate(work(b,10)) > CDate(work(b+1,10)) Or _"
htaFile.WriteLine "                   (CDate(work(b,10)) = CDate(work(b+1,10)) And CLng(keyA) > CLng(keyB)) Then"
htaFile.WriteLine "                    For j = 0 To 11"
htaFile.WriteLine "                        tmp = work(b,j)"
htaFile.WriteLine "                        work(b,j) = work(b+1,j)"
htaFile.WriteLine "                        work(b+1,j) = tmp"
htaFile.WriteLine "                    Next"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            ElseIf Not IsDate(work(b,10)) And IsDate(work(b+1,10)) Then"
htaFile.WriteLine "                ' Push non-dated rows to the end if encountered'"
htaFile.WriteLine "                For j = 0 To 11"
htaFile.WriteLine "                    tmp = work(b,j)"
htaFile.WriteLine "                    work(b,j) = work(b+1,j)"
htaFile.WriteLine "                    work(b+1,j) = tmp"
htaFile.WriteLine "                Next"
htaFile.WriteLine "            End If"
htaFile.WriteLine "        Next"
htaFile.WriteLine "    Next"
htaFile.WriteLine ""
htaFile.WriteLine "    ' Identify earliest WO receipt (I with WO:)'"
htaFile.WriteLine "    Dim receiptIdx: receiptIdx = -1"
htaFile.WriteLine "    For i = 0 To wCount - 1"
htaFile.WriteLine "        If work(i,3) = ""I"" And InStr(work(i,7), ""WO:"") > 0 Then"
htaFile.WriteLine "            receiptIdx = i"
htaFile.WriteLine "            Exit For"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine ""
htaFile.WriteLine "    ' Prepare usage tracking for transfer pairing & final selection'"
htaFile.WriteLine "    Dim used() : ReDim used(wCount - 1)"
htaFile.WriteLine "    For i = 0 To wCount - 1: used(i)=0: Next"
htaFile.WriteLine ""
htaFile.WriteLine "    Dim lifecycleHTML, stepNum"
htaFile.WriteLine "    lifecycleHTML = ""<h4 style='margin:0 0 8px 0;font-size:13px;'>Lifecycle Template</h4>"""
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""<div class='table-container'>"""
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""<table class='lifecycle-table'>"""
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""<tr><th>Date/Time</th><th>Action</th><th>From</th><th>To</th><th>Qty</th><th>Reference</th><th>User</th></tr>"""
htaFile.WriteLine "    stepNum = 0"
htaFile.WriteLine ""
htaFile.WriteLine "    Dim currentLocation, rowClass"
htaFile.WriteLine ""
htaFile.WriteLine "    ' 1. WO Receipt (at most one)'"
htaFile.WriteLine "    If receiptIdx <> -1 Then"
htaFile.WriteLine "        stepNum = stepNum + 1"
htaFile.WriteLine "        currentLocation = work(receiptIdx,6)"
htaFile.WriteLine "        rowClass = ""lifecycle-wo"""
htaFile.WriteLine "        If work(receiptIdx,0) = selectedTransID Then rowClass = rowClass & "" lifecycle-current"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<tr class='"" & rowClass & ""'>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(receiptIdx,1) & "" "" & work(receiptIdx,2) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td><b>RECEIPT (WO)</b></td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>-</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(receiptIdx,6) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td align='right'>"" & FormatNumber(work(receiptIdx,4),2) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(receiptIdx,7) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(receiptIdx,8) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""</tr>"""
htaFile.WriteLine "        used(receiptIdx)=1"
htaFile.WriteLine "    Else"
htaFile.WriteLine "        ' No WO receipt: pick earliest transaction as starting point (optional)."
htaFile.WriteLine "        currentLocation = """" ' Will be set when first transfer OUT found"
htaFile.WriteLine "    End If"
htaFile.WriteLine ""
htaFile.WriteLine "    ' 2. Transfers chain: pair OUT (O no CO) + IN (I not WO/PO) AFTER it'"
htaFile.WriteLine "    Dim iOut, iIn, bestIn, minTimeDiff, timeDiff, qtyOut"
htaFile.WriteLine "    For iOut = 0 To wCount - 1"
htaFile.WriteLine "        If used(iOut)=0 Then"
htaFile.WriteLine "            ' OUT candidate'"
htaFile.WriteLine "            If work(iOut,3) = ""O"" And InStr(work(iOut,7), ""CO:"")=0 Then"
htaFile.WriteLine "                ' Optionally require starting location continuity if we already have one"
htaFile.WriteLine "                If currentLocation = """" Or currentLocation = work(iOut,6) Then"
htaFile.WriteLine "                    qtyOut = Abs(CDbl(work(iOut,4)))"
htaFile.WriteLine "                    ' Find earliest IN after iOut matching criteria'"
htaFile.WriteLine "                    bestIn = -1"
htaFile.WriteLine "                    minTimeDiff = 999999"
htaFile.WriteLine "                    For iIn = iOut + 1 To wCount - 1"
htaFile.WriteLine "                        If used(iIn)=0 Then"
htaFile.WriteLine "                            If work(iIn,3) = ""I"" Then"
htaFile.WriteLine "                                ' Must NOT be WO or PO receipt'"
htaFile.WriteLine "                                If InStr(work(iIn,7), ""WO:"")=0 And InStr(work(iIn,7), ""PO:"")=0 Then"
htaFile.WriteLine "                                    ' Match by absolute quantity (remove this IF to allow ANY qty) '"
htaFile.WriteLine "                                    If Abs(CDbl(work(iIn,4))) = qtyOut Then"
htaFile.WriteLine "                                        timeDiff = DateDiff(""s"", work(iOut,10), work(iIn,10))"
htaFile.WriteLine "                                        If timeDiff >= 0 Then"
htaFile.WriteLine "                                            If timeDiff < minTimeDiff Then"
htaFile.WriteLine "                                                minTimeDiff = timeDiff"
htaFile.WriteLine "                                                bestIn = iIn"
htaFile.WriteLine "                                            End If"
htaFile.WriteLine "                                        End If"
htaFile.WriteLine "                                    End If"
htaFile.WriteLine "                                End If"
htaFile.WriteLine "                            End If"
htaFile.WriteLine "                        End If"
htaFile.WriteLine "                    Next"
htaFile.WriteLine "                    If bestIn <> -1 Then"
htaFile.WriteLine "                        stepNum = stepNum + 1"
htaFile.WriteLine "                        rowClass = ""lifecycle-transfer"""
htaFile.WriteLine "                        If work(iOut,0)=selectedTransID Or work(bestIn,0)=selectedTransID Then rowClass = rowClass & "" lifecycle-current"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<tr class='"" & rowClass & ""'>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td>"" & work(iOut,1) & "" "" & work(iOut,2) & ""</td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td><b>TRANSFER</b></td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td>"" & work(iOut,6) & ""</td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td>"" & work(bestIn,6) & ""</td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td align='right'>"" & FormatNumber(work(iOut,4),2) & ""</td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td>Transfer</td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""<td>"" & work(iOut,8) & ""</td>"""
htaFile.WriteLine "                        lifecycleHTML = lifecycleHTML & ""</tr>"""
htaFile.WriteLine "                        used(iOut)=1"
htaFile.WriteLine "                        used(bestIn)=1"
htaFile.WriteLine "                        currentLocation = work(bestIn,6) ' advance current location"
htaFile.WriteLine "                    End If"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            End If"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine ""
htaFile.WriteLine "    ' 3. Final Shipment (O with CO:), only if it matches the current location exactly"
htaFile.WriteLine "    Dim shipIdx: shipIdx = -1"
htaFile.WriteLine "    For i = 0 To wCount - 1"
htaFile.WriteLine "        If used(i)=0 Then"
htaFile.WriteLine "            If work(i,3) = ""O"" And InStr(work(i,7), ""CO:"") > 0 Then"
htaFile.WriteLine "                ' Only accept shipment if it matches the current location (no fallback)"
htaFile.WriteLine "                If currentLocation <> """" And work(i,6) = currentLocation Then"
htaFile.WriteLine "                    shipIdx = i"
htaFile.WriteLine "                    Exit For"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            End If"
htaFile.WriteLine "        End If"
htaFile.WriteLine "    Next"
htaFile.WriteLine "    If shipIdx <> -1 Then"
htaFile.WriteLine "        stepNum = stepNum + 1"
htaFile.WriteLine "        rowClass = ""lifecycle-ship"""
htaFile.WriteLine "        If work(shipIdx,0)=selectedTransID Then rowClass = rowClass & "" lifecycle-current"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<tr class='"" & rowClass & ""'>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(shipIdx,1) & "" "" & work(shipIdx,2) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td><b>SHIPMENT</b></td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(shipIdx,6) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>Customer</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td align='right'>"" & FormatNumber(work(shipIdx,4),2) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(shipIdx,7) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""<td>"" & work(shipIdx,8) & ""</td>"""
htaFile.WriteLine "        lifecycleHTML = lifecycleHTML & ""</tr>"""
htaFile.WriteLine "        used(shipIdx)=1"
htaFile.WriteLine "    End If"
htaFile.WriteLine ""
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""</table>"""
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""</div>"""
htaFile.WriteLine ""
htaFile.WriteLine "    ' Optional unmatched info (debug) - can comment out'"
htaFile.WriteLine "    Dim unmatched: unmatched = 0"
htaFile.WriteLine "    For i = 0 To wCount - 1: If used(i)=0 Then unmatched = unmatched + 1: End If: Next"
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""<p style='font-size:10px;margin-top:6px;color:#cccccc;'>Template shows: (WO Receipt -> Transfers -> Shipment). Unused transactions (not in chain): "" & unmatched & ""</p>"""
htaFile.WriteLine "    lifecycleHTML = lifecycleHTML & ""<p style='font-size:10px;margin-top:3px;color:#cccccc;'>Legend: <span style='background:#1a4c2e;padding:2px 6px;border-radius:3px;margin-right:6px;font-size:10px;'>Receipt</span> <span style='background:#4c3a1a;padding:2px 6px;border-radius:3px;margin-right:6px;font-size:10px;'>Transfer</span> <span style='background:#4c1a1a;padding:2px 6px;border-radius:3px;margin-right:6px;font-size:10px;'>Shipment</span> <span style='background:#ffd700;color:#000;padding:2px 6px;border-radius:3px;font-size:10px;'>Selected</span></p>"""
htaFile.WriteLine ""
htaFile.WriteLine "    document.getElementById(""lifecycleContent"").innerHTML = lifecycleHTML"
htaFile.WriteLine "End Sub"
' ================== END LIFECYCLE TEMPLATE ==================



' ===== END FULL PART LIFECYCLE SECTION =====
htaFile.WriteLine ""
htaFile.WriteLine "Function GetActionDescription(transType, reference)"
htaFile.WriteLine "    If transType = ""I"" And InStr(reference, ""WO:"") > 0 Then"
htaFile.WriteLine "        GetActionDescription = ""RECEIPT from Work Order"""
htaFile.WriteLine "    ElseIf transType = ""I"" Then"
htaFile.WriteLine "        GetActionDescription = ""TRANSFER IN"""
htaFile.WriteLine "    ElseIf transType = ""O"" And InStr(reference, ""CO:"") > 0 Then"
htaFile.WriteLine "        GetActionDescription = ""SHIPMENT to Customer"""
htaFile.WriteLine "    ElseIf transType = ""O"" Then"
htaFile.WriteLine "        GetActionDescription = ""TRANSFER OUT"""
htaFile.WriteLine "    Else"
htaFile.WriteLine "        GetActionDescription = transType"
htaFile.WriteLine "    End If"
htaFile.WriteLine "End Function"
htaFile.WriteLine ""
htaFile.WriteLine "Sub SortTable(col)"
htaFile.WriteLine "    If sortColumn = col Then"
htaFile.WriteLine "        sortAscending = Not sortAscending"
htaFile.WriteLine "    Else"
htaFile.WriteLine "        sortColumn = col"
htaFile.WriteLine "        sortAscending = True"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    "
htaFile.WriteLine "    Dim i, j, temp, k"
htaFile.WriteLine "    For i = 0 To rowCount - 2"
htaFile.WriteLine "        For j = 0 To rowCount - i - 2"
htaFile.WriteLine "            Dim swap"
htaFile.WriteLine "            swap = False"
htaFile.WriteLine "            "
htaFile.WriteLine "            If col = 4 Then"
htaFile.WriteLine "                If sortAscending Then"
htaFile.WriteLine "                    If CDbl(tableData(j, col)) > CDbl(tableData(j + 1, col)) Then swap = True"
htaFile.WriteLine "                Else"
htaFile.WriteLine "                    If CDbl(tableData(j, col)) < CDbl(tableData(j + 1, col)) Then swap = True"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            ElseIf col = 1 Or col = 2 Then"
htaFile.WriteLine "                If sortAscending Then"
htaFile.WriteLine "                    If CDate(tableData(j, 10)) > CDate(tableData(j + 1, 10)) Then swap = True"
htaFile.WriteLine "                Else"
htaFile.WriteLine "                    If CDate(tableData(j, 10)) < CDate(tableData(j + 1, 10)) Then swap = True"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            Else"
htaFile.WriteLine "                If sortAscending Then"
htaFile.WriteLine "                    If tableData(j, col) > tableData(j + 1, col) Then swap = True"
htaFile.WriteLine "                Else"
htaFile.WriteLine "                    If tableData(j, col) < tableData(j + 1, col) Then swap = True"
htaFile.WriteLine "                End If"
htaFile.WriteLine "            End If"
htaFile.WriteLine "            "
htaFile.WriteLine "            If swap Then"
htaFile.WriteLine "                For k = 0 To 11"
htaFile.WriteLine "                    temp = tableData(j, k)"
htaFile.WriteLine "                    tableData(j, k) = tableData(j + 1, k)"
htaFile.WriteLine "                    tableData(j + 1, k) = temp"
htaFile.WriteLine "                Next"
htaFile.WriteLine "            End If"
htaFile.WriteLine "        Next"
htaFile.WriteLine "    Next"
htaFile.WriteLine "    "
htaFile.WriteLine "    DisplayTable"
htaFile.WriteLine "End Sub"
htaFile.WriteLine ""
htaFile.WriteLine "Sub ExportData"
htaFile.WriteLine "    If rowCount = 0 Then"
htaFile.WriteLine "        MsgBox ""No data to export"", vbInformation"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine ""
htaFile.WriteLine "    On Error Resume Next"
htaFile.WriteLine "    Dim fso, docPath, file, fileName, i, exportText"
htaFile.WriteLine "    Set fso = CreateObject(""Scripting.FileSystemObject"")"
htaFile.WriteLine "    docPath = fso.GetSpecialFolder(5)"
htaFile.WriteLine "    If docPath = """" Or IsNull(docPath) Then"
htaFile.WriteLine "        MsgBox ""Could not locate your My Documents folder. Export cancelled."", vbCritical"
htaFile.WriteLine "        Exit Sub"
htaFile.WriteLine "    End If"
htaFile.WriteLine "    fileName = docPath & ""\PartTrans_"" & currentPartID & ""_"" & Replace(Date, ""/"", """") & "".txt"""
htaFile.WriteLine ""
htaFile.WriteLine "    exportText = ""Trans ID"" & vbTab & ""Date"" & vbTab & ""Time"" & vbTab & ""Type"" & vbTab"
htaFile.WriteLine "    exportText = exportText & ""Qty"" & vbTab & ""Warehouse"" & vbTab & ""Location"" & vbTab"
htaFile.WriteLine "    exportText = exportText & ""Reference"" & vbTab & ""User"" & vbCrLf"
htaFile.WriteLine ""
htaFile.WriteLine "    For i = 0 To rowCount - 1"
htaFile.WriteLine "        exportText = exportText & tableData(i, 0) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 1) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 2) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 3) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 4) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 5) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 6) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 7) & vbTab"
htaFile.WriteLine "        exportText = exportText & tableData(i, 8) & vbCrLf"
htaFile.WriteLine "    Next"
htaFile.WriteLine ""
htaFile.WriteLine "    Set file = fso.CreateTextFile(fileName, True)"
htaFile.WriteLine "    file.Write exportText"
htaFile.WriteLine "    file.Close"
htaFile.WriteLine "    MsgBox ""Exported to: "" & fileName, vbInformation"
htaFile.WriteLine "End Sub"
htaFile.WriteLine "</script>"
htaFile.WriteLine "</body>"
htaFile.WriteLine "</html>"

htaFile.Close

' Launch the HTA
CreateObject("WScript.Shell").Run """" & htaPath & """", 1, False